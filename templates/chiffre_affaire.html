{% extends "base.html" %}
{% block title %}Chiffre dâ€™affaires{% endblock %}

{% block content %}

<!-- ================= PAGE HEADER ================= -->
<div class="page-header mb-4">
    <h1>Chiffre dâ€™affaires</h1>
    <p class="text-muted">Suivi des performances financiÃ¨res</p>
</div>

<!-- ================= KPI PRINCIPAUX ================= -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:18px;margin-bottom:32px;">

    <div class="kpi-tile">
        <div class="kpi-label">
            {% if current_user.role == 'admin' %}
                Chiffre dâ€™affaires annuel (global)
            {% else %}
                Votre chiffre dâ€™affaires annuel
            {% endif %}
        </div>
        <div class="kpi-value">{{ ca_annuel_perso }} â‚¬</div>
    </div>

    <div class="kpi-tile">
        <div class="kpi-label">
            {% if current_user.role == 'admin' %}
                Chiffre dâ€™affaires mensuel (global)
            {% else %}
                Votre chiffre dâ€™affaires mensuel
            {% endif %}
        </div>
        <div class="kpi-value">{{ ca_mensuel_perso }} â‚¬</div>
    </div>

</div>

<!-- ================= AJOUT CA (ADMIN) ================= -->
{% if current_user.role == 'admin' %}
<div class="card mb-4">
    <h5>Ajouter un chiffre dâ€™affaires</h5>

    <form method="POST" action="{{ url_for('add_chiffre_affaire') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

        <div class="row g-3">
            <div class="col-md-3">
                <label>Date</label>
                <input type="date" name="date" class="form-control" required>
            </div>

            <div class="col-md-4">
                <label>Dossier client</label>
                <select name="client_id" class="form-select" required>
                    <option value="">â€” SÃ©lectionner â€”</option>
                    {% for c in clients %}
                        <option value="{{ c.id }}">{{ c.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3">
                <label>Commercial</label>
                <input type="text" name="commercial" class="form-control" required>
            </div>

            <div class="col-md-2">
                <label>Montant (â‚¬)</label>
                <input type="number" step="0.01" name="montant" class="form-control" required>
            </div>
        </div>

        <div class="mt-3 text-end">
            <button class="btn btn-success">Ajouter</button>
        </div>
    </form>
</div>
{% endif %}

<!-- ================= HISTORIQUE CA (ADMIN) ================= -->
{% if current_user.role == 'admin' and historique_ca %}
<div class="card mb-4">
    <h5>Historique des chiffres dâ€™affaires</h5>

    <table class="table table-sm align-middle">
        <thead>
            <tr>
                <th>Date</th>
                <th>Dossier</th>
                <th>Commercial</th>
                <th>Montant</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
        {% for r in historique_ca %}
            <tr>
                <td>{{ r.date }}</td>
                <td>{{ r.client_name }}</td>
                <td>{{ r.commercial }}</td>
                <td>
                    <form method="POST"
                          action="{{ url_for('edit_chiffre_affaire', ca_id=r.id) }}"
                          class="d-flex gap-1">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        <input type="number" step="0.01" name="montant"
                               value="{{ r.montant }}"
                               class="form-control form-control-sm"
                               style="width:120px">
                        <button class="btn btn-sm btn-outline-primary">ðŸ’¾</button>
                    </form>
                </td>
                <td>
                    <form method="POST"
                          action="{{ url_for('delete_chiffre_affaire', ca_id=r.id) }}"
                          onsubmit="return confirm('Supprimer ce CA ?');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        <button class="btn btn-sm btn-outline-danger">ðŸ—‘</button>
                    </form>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- ================= GRAPHIQUE COMMERCIAL ================= -->
{% if current_user.role != 'admin' and ca_perso_par_mois %}
<div class="card mb-4">
    <h5>Votre chiffre dâ€™affaires mensuel (objectif 5 000 â‚¬)</h5>
    <canvas id="chartMensuelPerso"></canvas>
</div>

<script>
(function () {
    if (typeof Chart === "undefined") {
        console.warn("Chart.js non chargÃ© : graphique mensuel non affichÃ©.");
        return;
    }

    const labelsMois = [{% for r in ca_perso_par_mois %}"{{ r.mois }}",{% endfor %}];
    const dataCA = [{% for r in ca_perso_par_mois %}{{ r.total }},{% endfor %}];
    const objectif = labelsMois.map(() => 5000);

    new Chart(document.getElementById('chartMensuelPerso'), {
        type: 'line',
        data: {
            labels: labelsMois,
            datasets: [
                {
                    label: 'Votre CA',
                    data: dataCA,
                    borderColor: '#2563eb',
                    tension: 0.3
                },
                {
                    label: 'Objectif 5 000 â‚¬',
                    data: objectif,
                    borderDash: [6,6],
                    borderColor: '#dc2626'
                }
            ]
        }
    });
})();
</script>
{% endif %}

<!-- ================= GRAPHIQUE ADMIN GLOBAL ================= -->
{% if current_user.role == 'admin' and global_par_mois %}
<div class="card mb-4">
    <h5>Chiffre dâ€™affaires global par mois</h5>
    <canvas id="chartGlobal"></canvas>
</div>

<script>
(function () {
    if (typeof Chart === "undefined") {
        console.warn("Chart.js non chargÃ© : graphique global non affichÃ©.");
        return;
    }

    new Chart(document.getElementById('chartGlobal'), {
        type: 'line',
        data: {
            labels: [{% for r in global_par_mois %}"{{ r.mois }}",{% endfor %}],
            datasets: [{
                label: 'CA global',
                data: [{% for r in global_par_mois %}{{ r.total }},{% endfor %}],
                borderColor: '#16a34a',
                tension: 0.3
            }]
        }
    });
})();
</script>
{% endif %}

{% endblock %}

{% extends "base.html" %}
{% block title %}Chiffre d’affaires{% endblock %}

{% block content %}

<!-- ================= PAGE HEADER ================= -->
<div class="page-header mb-4">
    <h1>Chiffre d’affaires</h1>
    <p class="text-muted">Suivi des performances financières</p>
</div>

<!-- ================= KPI PRINCIPAUX ================= -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:18px;margin-bottom:32px;">

    <div class="kpi-tile">
        <div class="kpi-label">
            {% if current_user.role == 'admin' %}
                Chiffre d’affaires annuel (global)
            {% else %}
                Votre chiffre d’affaires annuel
            {% endif %}
        </div>
        <div class="kpi-value">{{ ca_annuel_perso }} €</div>
    </div>

    <div class="kpi-tile">
        <div class="kpi-label">
            {% if current_user.role == 'admin' %}
                Chiffre d’affaires mensuel (global)
            {% else %}
                Votre chiffre d’affaires mensuel
            {% endif %}
        </div>
        <div class="kpi-value">{{ ca_mensuel_perso }} €</div>
    </div>

</div>

<!-- ================= AJOUT CA (ADMIN) ================= -->
{% if current_user.role == 'admin' %}
<div class="card mb-4">
    <h5>Ajouter un chiffre d’affaires</h5>

    <form method="POST" action="{{ url_for('add_chiffre_affaire') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

        <div class="row g-3">
            <div class="col-md-3">
                <label>Date</label>
                <input type="date" name="date" class="form-control" required>
            </div>

            <div class="col-md-4">
                <label>Dossier client</label>
                <select name="client_id" class="form-select" required>
                    <option value="">— Sélectionner —</option>
                    {% for c in clients %}
                        <option value="{{ c.id }}">{{ c.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3">
                <label>Commercial</label>
                <input type="text" name="commercial" class="form-control" required>
            </div>

            <div class="col-md-2">
                <label>Montant (€)</label>
                <input type="number" step="0.01" name="montant" class="form-control" required>
            </div>
        </div>

        <div class="mt-3 text-end">
            <button class="btn btn-success">Ajouter</button>
        </div>
    </form>
</div>
{% endif %}

<!-- ================= HISTORIQUE CA (ADMIN) ================= -->
{% if current_user.role == 'admin' and historique_ca %}
<div class="card mb-4">
    <h5>Historique des chiffres d’affaires</h5>

    <table class="table table-sm align-middle">
        <thead>
            <tr>
                <th>Date</th>
                <th>Dossier</th>
                <th>Commercial</th>
                <th>Montant</th>
            </tr>
        </thead>
        <tbody>
        {% for r in historique_ca %}
            <tr>
                <td>{{ r.date }}</td>
                <td>{{ r.client_name }}</td>
                <td>{{ r.commercial }}</td>
                <td><strong>{{ r.montant }} €</strong></td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <!--
        ⚠️ ÉDITION / SUPPRESSION DÉSACTIVÉES VOLONTAIREMENT
        Les routes edit_chiffre_affaire et delete_chiffre_affaire
        ne sont PAS définies dans app.py.
        Cela évite toute erreur 500 et toute régression.
    -->
</div>
{% endif %}

<!-- ================= GRAPHIQUE COMMERCIAL ================= -->
{% if current_user.role != 'admin' and ca_perso_par_mois %}
<div class="card mb-4">
    <h5>Votre chiffre d’affaires mensuel (objectif 5 000 €)</h5>
    <canvas id="chartMensuelPerso"></canvas>
</div>

<script>
(function () {
    if (typeof Chart === "undefined") {
        console.warn("Chart.js non chargé : graphique mensuel non affiché.");
        return;
    }

    const labelsMois = [{% for r in ca_perso_par_mois %}"{{ r.mois }}",{% endfor %}];
    const dataCA = [{% for r in ca_perso_par_mois %}{{ r.total }},{% endfor %}];
    const objectif = labelsMois.map(() => 5000);

    new Chart(document.getElementById('chartMensuelPerso'), {
        type: 'line',
        data: {
            labels: labelsMois,
            datasets: [
                {
                    label: 'Votre CA',
                    data: dataCA,
                    borderColor: '#2563eb',
                    tension: 0.3
                },
                {
                    label: 'Objectif 5 000 €',
                    data: objectif,
                    borderDash: [6,6],
                    borderColor: '#dc2626'
                }
            ]
        }
    });
})();
</script>
{% endif %}

<!-- ================= GRAPHIQUE ADMIN GLOBAL ================= -->
{% if current_user.role == 'admin' and global_par_mois %}
<div class="card mb-4">
    <h5>Chiffre d’affaires global par mois</h5>
    <canvas id="chartGlobal"></canvas>
</div>

<script>
(function () {
    if (typeof Chart === "undefined") {
        console.warn("Chart.js non chargé : graphique global non affiché.");
        return;
    }

    new Chart(document.getElementById('chartGlobal'), {
        type: 'line',
        data: {
            labels: [{% for r in global_par_mois %}"{{ r.mois }}",{% endfor %}],
            datasets: [{
                label: 'CA global',
                data: [{% for r in global_par_mois %}{{ r.total }},{% endfor %}],
                borderColor: '#16a34a',
                tension: 0.3
            }]
        }
    });
})();
</script>
{% endif %}

{% endblock %}

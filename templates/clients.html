{% extends "base.html" %}
{% block title %}Clients{% endblock %}

{% block content %}

<!-- ================= PAGE HEADER ================= -->
<div
    class="page-header"
    style="
        display:flex;
        justify-content:space-between;
        align-items:center;
        gap:16px;
        margin-bottom:24px;
        flex-wrap:wrap;
    "
>
    <div>
        <h1>Clients</h1>
        <p class="text-muted">Gestion des dossiers clients</p>
    </div>

    <a
        href="{{ url_for('new_client') }}"
        class="btn btn-primary"
    >
        ➕ Nouveau dossier
    </a>
</div>

<!-- ================= SEARCH ================= -->
<div class="card mb-4">
    <form
        method="get"
        action="{{ url_for('clients') }}"
        style="
            display:flex;
            gap:12px;
            align-items:center;
            flex-wrap:wrap;
        "
    >
        <input
            type="text"
            name="q"
            placeholder="Rechercher un dossier…"
            value="{{ q or '' }}"
            class="form-control"
            style="max-width:320px;"
        >

        <button
            type="submit"
            class="btn btn-rechercher"
        >
            Rechercher
        </button>
    </form>
</div>

<!-- ================= LISTE CLIENTS ================= -->
<div class="card">

{% if clients %}
    <table class="table align-middle">
        <thead>
            <tr>
                <th>Dossier</th>
                <th>Commercial</th>
                <th>Statut</th>
                <th>Date de création</th>
                <th style="text-align:right;">Action</th>
            </tr>
        </thead>

        <tbody>
            {% for c in clients %}
            <tr>
                <td>
                    <strong>{{ c.name }}</strong>
                </td>

                <td>
                    {{ c.commercial or "—" }}
                </td>

                <!-- ✅ STATUT MODIFIABLE (commercial + admin) -->
                <td style="max-width:180px;">
                    <form
                        method="post"
                        action="{{ url_for('update_client_status', client_id=c.id) }}"
                    >
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

                        <select
                            name="status"
                            class="form-select form-select-sm"
                            onchange="this.form.submit()"
                        >
                            <option value="en_cours"
                                {% if c.status == 'en_cours' %}selected{% endif %}>
                                En cours
                            </option>

                            <option value="gagne"
                                {% if c.status == 'gagne' %}selected{% endif %}>
                                Gagné
                            </option>

                            <option value="perdu"
                                {% if c.status == 'perdu' %}selected{% endif %}>
                                Perdu
                            </option>

                            <option value="demande_maj"
                                {% if c.status == 'demande_maj' %}selected{% endif %}>
                                Demande de MAJ
                            </option>
                        </select>
                    </form>
                </td>

                <td>
                    {{ format_date(c.created_at) }}
                </td>

                <td style="text-align:right;">
                    <a
                        href="{{ url_for('client_detail', client_id=c.id) }}"
                        class="btn btn-ouvrir btn-sm"
                    >
                        Ouvrir
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

{% else %}
    <p class="text-muted mb-0">
        Aucun dossier trouvé.
    </p>
{% endif %}

</div>

{% endblock %}

{% extends "base.html" %}
{% block title %}Clients{% endblock %}

{% block content %}

<!-- ================= PAGE HEADER ================= -->
<div class="page-header"
     style="display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:24px;flex-wrap:wrap;">
    <div>
        <h1>Clients</h1>
        <p class="text-muted">Gestion des dossiers clients</p>
    </div>

    <button class="btn btn-primary"
            data-bs-toggle="collapse"
            data-bs-target="#newClientForm">
        âž• Nouveau dossier
    </button>
</div>

<!-- ================= CRÃ‰ATION CLIENT ================= -->
<div id="newClientForm" class="collapse mb-4">
    <div class="card">
        <div class="card-body">
            <h5 class="mb-3">CrÃ©er un nouveau dossier client</h5>

            <form method="post" action="{{ url_for('new_client') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

                <div class="row g-3">

                    <div class="col-md-6">
                        <label class="form-label">Nom du client *</label>
                        <input type="text"
                               name="name"
                               class="form-control"
                               required>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Nom du gÃ©rant</label>
                        <input type="text"
                               name="gerant_nom"
                               class="form-control">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Email</label>
                        <input type="email"
                               name="email"
                               class="form-control">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">TÃ©lÃ©phone</label>
                        <input type="text"
                               name="phone"
                               class="form-control">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Adresse</label>
                        <input type="text"
                               name="address"
                               class="form-control">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">SIRET</label>
                        <input type="text"
                               name="siret"
                               class="form-control">
                    </div>

                    <!-- COMMERCIAL (ADMIN UNIQUEMENT) -->
                    {% if current_user and current_user.role == "admin" %}
                    <div class="col-md-6">
                        <label class="form-label">Commercial *</label>
                        <input type="text"
                               name="commercial_name"
                               class="form-control"
                               placeholder="Ex : Julien, Admin, Jeremy"
                               required>
                    </div>
                    {% endif %}

                </div>

                <div class="mt-4">
                    <button type="submit" class="btn btn-success">
                        âœ” CrÃ©er le dossier
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ================= SEARCH ================= -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get"
              action="{{ url_for('clients') }}"
              style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
            <input type="text"
                   name="q"
                   placeholder="Rechercher un dossierâ€¦"
                   value="{{ q if q is defined else '' }}"
                   class="form-control"
                   style="max-width:320px;">
            <button type="submit" class="btn btn-secondary">
                Rechercher
            </button>
        </form>
    </div>
</div>

<h2 class="mb-4">
    {% if current_user and current_user.role == 'admin' %}
        Pipeline des dossiers
    {% else %}
        Mes dossiers
    {% endif %}
</h2>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;">

    <!-- ================= EN COURS ================= -->
    <div class="card">
        <div class="card-header fw-bold">
            ðŸŸ¡ En cours ({{ clients_en_cours|length if clients_en_cours is defined else 0 }})
        </div>

        <div class="card-body d-flex flex-column gap-2">
            {% if clients_en_cours %}
                {% for c in clients_en_cours %}
                <a href="{{ url_for('client_detail', client_id=c.id) }}"
                   class="border rounded p-2 text-decoration-none text-dark"
                   style="transition:background .15s;"
                   onmouseover="this.style.background='#f8f9fa'"
                   onmouseout="this.style.background='transparent'">

                    <strong>{{ c.name }}</strong><br>
                    <small class="text-muted">
                        Commercial : {{ c.commercial or "â€”" }}
                    </small>

                    {% if current_user and current_user.role == 'admin' %}
                    <form method="post"
                          action="{{ url_for('update_client_status', client_id=c.id) }}"
                          class="mt-2"
                          onclick="event.stopPropagation();">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        <select name="status"
                                class="form-select form-select-sm"
                                onchange="this.form.submit()">
                            <option value="en_cours" {% if c.status == 'en_cours' %}selected{% endif %}>
                                En cours
                            </option>
                            <option value="gagne" {% if c.status == 'gagne' %}selected{% endif %}>
                                GagnÃ©
                            </option>
                            <option value="perdu" {% if c.status == 'perdu' %}selected{% endif %}>
                                Perdu
                            </option>
                        </select>
                    </form>
                    {% endif %}
                </a>
                {% endfor %}
            {% else %}
                <p class="text-muted mb-0">Aucun dossier.</p>
            {% endif %}
        </div>
    </div>

    <!-- ================= GAGNÃ‰S ================= -->
    <div class="card border-success">
        <div class="card-header fw-bold text-success">
            ðŸŸ¢ GagnÃ©s ({{ clients_gagnes|length if clients_gagnes is defined else 0 }})
        </div>

        <div class="card-body d-flex flex-column gap-2">
            {% if clients_gagnes %}
                {% for c in clients_gagnes %}
                <a href="{{ url_for('client_detail', client_id=c.id) }}"
                   class="border border-success rounded p-2 text-decoration-none text-dark">
                    <strong>{{ c.name }}</strong><br>
                    <small class="text-muted">
                        Commercial : {{ c.commercial or "â€”" }}
                    </small>
                    <div class="text-success fw-bold mt-1">âœ” GagnÃ©</div>
                </a>
                {% endfor %}
            {% else %}
                <p class="text-muted mb-0">Aucun dossier gagnÃ©.</p>
            {% endif %}
        </div>
    </div>

    <!-- ================= PERDUS ================= -->
    <div class="card border-danger">
        <div class="card-header fw-bold text-danger">
            ðŸ”´ Perdus ({{ clients_perdus|length if clients_perdus is defined else 0 }})
        </div>

        <div class="card-body d-flex flex-column gap-2">
            {% if clients_perdus %}
                {% for c in clients_perdus %}
                <a href="{{ url_for('client_detail', client_id=c.id) }}"
                   class="border border-danger rounded p-2 text-decoration-none text-dark">
                    <strong>{{ c.name }}</strong><br>
                    <small class="text-muted">
                        Commercial : {{ c.commercial or "â€”" }}
                    </small>
                    <div class="text-danger fw-bold mt-1">âœ– Perdu</div>
                </a>
                {% endfor %}
            {% else %}
                <p class="text-muted mb-0">Aucun dossier perdu.</p>
            {% endif %}
        </div>
    </div>

</div>

{% endblock %}

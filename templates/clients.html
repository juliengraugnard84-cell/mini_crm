{% extends "base.html" %}
{% block title %}Clients{% endblock %}

{% block content %}

<!-- ================= PAGE HEADER ================= -->
<div class="page-header"
     style="display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:24px;flex-wrap:wrap;">
    <div>
        <h1>Clients</h1>
        <p class="text-muted">Gestion des dossiers clients</p>
    </div>

    <a href="{{ url_for('new_client') }}" class="btn btn-primary">
        âž• Nouveau dossier
    </a>
</div>

<!-- ================= SEARCH ================= -->
<div class="card mb-4">
    <form method="get"
          action="{{ url_for('clients') }}"
          style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
        <input type="text"
               name="q"
               placeholder="Rechercher un dossierâ€¦"
               value="{{ q or '' }}"
               class="form-control"
               style="max-width:320px;">
        <button type="submit" class="btn btn-rechercher">
            Rechercher
        </button>
    </form>
</div>

<h2 class="mb-4">
    {% if current_user.role == 'admin' %}
        Pipeline des dossiers
    {% else %}
        Mes dossiers
    {% endif %}
</h2>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;">

    <!-- ================= EN COURS ================= -->
    <div class="card">
        <div class="card-header fw-bold">
            ðŸŸ¡ En cours ({{ clients_en_cours|length }})
        </div>

        <div class="card-body d-flex flex-column gap-2">
            {% for c in clients_en_cours %}
            <div class="border rounded p-2">
                <strong>{{ c.name }}</strong><br>
                <small class="text-muted">
                    Commercial : {{ c.commercial or "â€”" }}
                </small>

                {% if current_user.role == 'admin' %}
                <form method="post"
                      action="{{ url_for('update_client', client_id=c.id) }}"
                      class="mt-2">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <select name="status"
                            class="form-select form-select-sm"
                            onchange="this.form.submit()">
                        <option value="en_cours" selected>En cours</option>
                        <option value="gagne">GagnÃ©</option>
                        <option value="perdu">Perdu</option>
                    </select>
                </form>
                {% endif %}

                <a href="{{ url_for('client_detail', client_id=c.id) }}"
                   class="btn btn-ouvrir btn-sm mt-2 w-100">
                    Ouvrir
                </a>
            </div>
            {% else %}
            <p class="text-muted mb-0">Aucun dossier.</p>
            {% endfor %}
        </div>
    </div>

    <!-- ================= GAGNÃ‰S ================= -->
    <div class="card border-success">
        <div class="card-header fw-bold text-success">
            ðŸŸ¢ GagnÃ©s ({{ clients_gagnes|length }})
        </div>

        <div class="card-body d-flex flex-column gap-2">
            {% for c in clients_gagnes %}
            <div class="border border-success rounded p-2">
                <strong>{{ c.name }}</strong><br>
                <small class="text-muted">
                    Commercial : {{ c.commercial or "â€”" }}
                </small>
                <div class="text-success fw-bold mt-1">âœ” GagnÃ©</div>
                <a href="{{ url_for('client_detail', client_id=c.id) }}"
                   class="btn btn-ouvrir btn-sm mt-2 w-100">
                    Ouvrir
                </a>
            </div>
            {% else %}
            <p class="text-muted mb-0">Aucun dossier gagnÃ©.</p>
            {% endfor %}
        </div>
    </div>

    <!-- ================= PERDUS ================= -->
    <div class="card border-danger">
        <div class="card-header fw-bold text-danger">
            ðŸ”´ Perdus ({{ clients_perdus|length }})
        </div>

        <div class="card-body d-flex flex-column gap-2">
            {% for c in clients_perdus %}
            <div class="border border-danger rounded p-2">
                <strong>{{ c.name }}</strong><br>
                <small class="text-muted">
                    Commercial : {{ c.commercial or "â€”" }}
                </small>
                <div class="text-danger fw-bold mt-1">âœ– Perdu</div>
                <a href="{{ url_for('client_detail', client_id=c.id) }}"
                   class="btn btn-ouvrir btn-sm mt-2 w-100">
                    Ouvrir
                </a>
            </div>
            {% else %}
            <p class="text-muted mb-0">Aucun dossier perdu.</p>
            {% endfor %}
        </div>
    </div>

</div>

{% endblock %}

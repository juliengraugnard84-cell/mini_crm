<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}CRM SynergyGroup{% endblock %}</title>

    <!-- Responsive -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- CSRF GLOBAL (AJAX + forms) -->
    <meta name="csrf-token" content="{{ csrf_token }}">

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Google Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">

    <!-- Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

    <!-- CSS principal -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    {% block head %}{% endblock %}
</head>

<body>

<div class="layout">

    <!-- ================= SIDEBAR ================= -->
    <aside class="sidebar">

        <div class="sidebar-logo">
            <strong>SynergyGroup</strong><br>
            <small>CRM interne</small>
        </div>

        <nav class="sidebar-nav">

            <a href="{{ url_for('dashboard') }}"
               class="sidebar-link {% if request.endpoint == 'dashboard' %}active{% endif %}">
                <span class="material-symbols-outlined">dashboard</span>
                Tableau de bord
            </a>

            <a href="{{ url_for('clients') }}"
               class="sidebar-link {% if request.endpoint in ['clients','client_detail','new_client','edit_client'] %}active{% endif %}">
                <span class="material-symbols-outlined">groups</span>
                Clients
            </a>

            <a href="{{ url_for('agenda') }}"
               class="sidebar-link {% if request.endpoint == 'agenda' %}active{% endif %}">
                <span class="material-symbols-outlined">calendar_month</span>
                Agenda
            </a>

            <a href="{{ url_for('chiffre_affaire') }}"
               class="sidebar-link {% if request.endpoint.startswith('chiffre_affaire') %}active{% endif %}">
                <span class="material-symbols-outlined">monitoring</span>
                Chiffre d’affaires
            </a>

            {% if current_user and current_user.role == 'admin' %}
                <hr style="border-color: rgba(255,255,255,.2);">

                <a href="{{ url_for('admin_users') }}"
                   class="sidebar-link {% if request.endpoint.startswith('admin_') %}active{% endif %}">
                    <span class="material-symbols-outlined">admin_panel_settings</span>
                    Utilisateurs
                </a>

                <a href="{{ url_for('documents') }}"
                   class="sidebar-link {% if request.endpoint == 'documents' %}active{% endif %}">
                    <span class="material-symbols-outlined">folder</span>
                    Documents
                </a>
            {% endif %}

        </nav>
    </aside>

    <!-- ================= CONTENT ================= -->
    <main class="content-wrapper">

        <!-- ===== TOPBAR ===== -->
        <div class="topbar">

            <div>
                <span class="fw-semibold">
                    Bonjour {{ current_user.username if current_user else '' }}
                </span>
            </div>

            <div class="d-flex align-items-center gap-3">
                <div class="topbar-avatar">
                    {{ current_user.username[0]|upper if current_user }}
                </div>

                <a href="{{ url_for('logout') }}" class="btn btn-sm btn-outline-danger">
                    <i class="bi bi-box-arrow-right me-1"></i> Déconnexion
                </a>
            </div>

        </div>

        <!-- ===== FLASH MESSAGES ===== -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} mb-3">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- ===== PAGE CONTENT ===== -->
        {% block content %}{% endblock %}

    </main>
</div>

<!-- ================= CHAT FLOAT ================= -->
<button id="chatBubble" title="Chat interne">
    <i class="bi bi-chat-dots-fill fs-4"></i>
</button>

<div id="chatWindow">
    <div id="chatHeader">
        <span>Chat interne</span>
        <button id="chatClose" class="btn btn-sm btn-light">✕</button>
    </div>

    <div id="chatMessages"></div>

    <div class="p-2 border-top">
        <input type="text" id="chatInput" class="form-control mb-2" placeholder="Votre message…">
        <input type="file" id="chatUpload" class="form-control mb-2">
        <button id="chatSend" class="btn btn-primary w-100">Envoyer</button>
    </div>
</div>

<!-- ================= JS ================= -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Chat widget -->
<script src="{{ url_for('static', filename='chat_widget.js') }}"></script>

<script>
    // Toggle chat
    const bubble = document.getElementById("chatBubble");
    const win = document.getElementById("chatWindow");
    const closeBtn = document.getElementById("chatClose");

    if (bubble && win && closeBtn) {
        bubble.addEventListener("click", () => {
            win.style.display = win.style.display === "flex" ? "none" : "flex";
        });
        closeBtn.addEventListener("click", () => {
            win.style.display = "none";
        });
    }
</script>

{% block scripts %}{% endblock %}

</body>
</html>

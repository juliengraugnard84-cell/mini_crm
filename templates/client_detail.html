{% extends "base.html" %}

{% block content %}

<!-- ================= PAGE HEADER ================= -->
<div class="page-header" style="margin-bottom:24px;">
    <h1>Dossier client</h1>
    <p class="text-muted">{{ client.name }}</p>
</div>

<!-- ================= TABS ================= -->
<ul class="nav nav-tabs mb-4" role="tablist">
    <li class="nav-item" role="presentation">
        <button
            class="nav-link active"
            id="tab-cotations"
            data-bs-toggle="tab"
            data-bs-target="#cotations"
            type="button"
            role="tab"
            aria-controls="cotations"
            aria-selected="true"
        >
            Cotations
        </button>
    </li>

    <li class="nav-item" role="presentation">
        <button
            class="nav-link"
            id="tab-updates"
            data-bs-toggle="tab"
            data-bs-target="#updates"
            type="button"
            role="tab"
            aria-controls="updates"
            aria-selected="false"
        >
            Mise à jour
        </button>
    </li>
</ul>

<div class="tab-content">

<!-- ======================================================
     ONGLET COTATIONS
====================================================== -->
<div
    class="tab-pane fade show active"
    id="cotations"
    role="tabpanel"
    aria-labelledby="tab-cotations"
>

{% if current_user.role in ['commercial', 'admin'] %}
<div class="card" style="margin-bottom:24px;">
    <h5>Nouvelle demande de cotation</h5>

    <p class="text-muted mb-3">
        Renseignez les informations nécessaires pour lancer une demande.
    </p>

    <form
        method="post"
        action="{{ url_for('create_cotation', client_id=client.id) }}"
    >
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

        <div class="row g-3">

            <div class="col-md-4">
                <label class="form-label">Date de négociation</label>
                <input
                    type="date"
                    name="date_negociation"
                    class="form-control"
                    required
                >
            </div>

            <div class="col-md-4">
                <label class="form-label">Énergie</label>
                <select
                    name="energie_type"
                    class="form-select"
                    required
                >
                    <option value="">— Choisir —</option>
                    <option value="gaz">Gaz</option>
                    <option value="electricite">Électricité</option>
                </select>
            </div>

            <div class="col-md-4">
                <label class="form-label">PDL / PCE</label>
                <input
                    type="text"
                    name="pdl_pce"
                    class="form-control"
                >
            </div>

            <div class="col-md-4">
                <label class="form-label">Date d’échéance</label>
                <input
                    type="date"
                    name="date_echeance"
                    class="form-control"
                >
            </div>

            <div class="col-md-4">
                <label class="form-label">Fournisseur actuel</label>
                <input
                    type="text"
                    name="fournisseur_actuel"
                    class="form-control"
                >
            </div>

            <div class="col-md-4">
                <label class="form-label">Entreprise</label>
                <input
                    type="text"
                    name="entreprise_nom"
                    class="form-control"
                >
            </div>

            <div class="col-md-4">
                <label class="form-label">SIRET</label>
                <input
                    type="text"
                    name="siret"
                    class="form-control"
                >
            </div>

            <div class="col-md-4">
                <label class="form-label">Signataire</label>
                <input
                    type="text"
                    name="signataire_nom"
                    class="form-control"
                >
            </div>

            <div class="col-md-4">
                <label class="form-label">Téléphone</label>
                <input
                    type="text"
                    name="signataire_tel"
                    class="form-control"
                >
            </div>

            <div class="col-md-6">
                <label class="form-label">Email</label>
                <input
                    type="email"
                    name="signataire_email"
                    class="form-control"
                >
            </div>

            <div class="col-md-12">
                <label class="form-label">Commentaire</label>
                <textarea
                    name="commentaire"
                    class="form-control"
                    rows="3"
                ></textarea>
            </div>

        </div>

        <div class="mt-4 text-end">
            <button type="submit" class="btn btn-primary">
                Créer la demande
            </button>
        </div>
    </form>
</div>
{% endif %}

<!-- ================= HISTORIQUE ================= -->
<div class="card">
    <h5>Historique des cotations</h5>

    {% if cotations %}
        <table class="table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Énergie</th>
                    <th>Statut</th>
                </tr>
            </thead>
            <tbody>
                {% for c in cotations %}
                <tr>
                    <td>{{ format_date(c.date_creation) }}</td>
                    <td>{{ c.energie_type or "—" }}</td>
                    <td>
                        <span class="text-muted">
                            {{ c.status or "—" }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="text-muted mb-0">
            Aucune cotation enregistrée.
        </p>
    {% endif %}
</div>

</div>

<!-- ======================================================
     ONGLET MISE À JOUR
====================================================== -->
<div
    class="tab-pane fade"
    id="updates"
    role="tabpanel"
    aria-labelledby="tab-updates"
>

{% if current_user.role == 'commercial' %}
<div class="card">
    <h5>Demande de mise à jour du dossier</h5>

    <p class="text-muted mb-3">
        Cette demande sera transmise à l’administrateur.
    </p>

    <form
        method="post"
        action="{{ url_for('update_client', client_id=client.id) }}"
    >
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

        <div class="row g-3">

            <div class="col-md-4">
                <label class="form-label">Date souhaitée</label>
                <input
                    type="date"
                    name="update_date"
                    class="form-control"
                    required
                >
            </div>

            <div class="col-md-12">
                <label class="form-label">Commentaire</label>
                <textarea
                    name="update_commentaire"
                    class="form-control"
                    rows="4"
                    required
                ></textarea>
            </div>

        </div>

        <div class="mt-4 text-end">
            <button type="submit" class="btn btn-warning">
                Envoyer à l’administrateur
            </button>
        </div>
    </form>
</div>

{% else %}
<p class="text-muted">
    Les demandes de mise à jour sont accessibles dans l’espace administrateur.
</p>
{% endif %}

</div>

</div>

{% endblock %}

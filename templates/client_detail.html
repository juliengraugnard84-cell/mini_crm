{% extends "base.html" %}
{% block title %}Dossier client{% endblock %}

{% block content %}

<!-- ================= PAGE HEADER ================= -->
<div class="page-header mb-4 d-flex justify-content-between align-items-center">
    <div>
        <h1>Dossier client</h1>
        <p class="text-muted mb-0">{{ client.name }}</p>
    </div>

    {% if current_user
          and current_user.role == 'admin'
          and available_endpoints
          and 'delete_client' in available_endpoints %}
    <form method="post"
          action="{{ url_for('delete_client', client_id=client.id) }}"
          onsubmit="return confirm('SUPPRIMER D√âFINITIVEMENT ce dossier client ?');">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <button type="submit" class="btn btn-danger">
            Supprimer le dossier client
        </button>
    </form>
    {% endif %}
</div>

<!-- ================= STATUT DOSSIER ================= -->
{% if current_user
      and (current_user.role == "admin" or current_user.id == client.owner_id)
      and available_endpoints
      and 'update_client_status' in available_endpoints %}
<div class="card mb-4">
    <div class="card-header">
        <strong>Statut du dossier</strong>
    </div>
    <div class="card-body" style="max-width:300px;">
        <form method="post"
              action="{{ url_for('update_client_status', client_id=client.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

            <select name="status"
                    class="form-select"
                    onchange="this.form.submit()">
                <option value="en_cours" {% if (client.status or '')|lower == "en_cours" %}selected{% endif %}>
                    üü° En cours
                </option>
                <option value="gagne" {% if (client.status or '')|lower == "gagne" %}selected{% endif %}>
                    üü¢ Gagn√©
                </option>
                <option value="perdu" {% if (client.status or '')|lower == "perdu" %}selected{% endif %}>
                    üî¥ Perdu
                </option>
            </select>
        </form>
    </div>
</div>
{% endif %}

<!-- ================= FICHE ENTREPRISE ================= -->
<div class="card mb-4">
    <div class="card-header">
        <strong>Fiche entreprise</strong>
    </div>
    <div class="card-body">
        <div class="row">

            <div class="col-md-6 mb-2">
                <strong>Entreprise :</strong><br>
                {{ client.name }}
            </div>

            <div class="col-md-6 mb-2">
                <strong>Nom du g√©rant :</strong><br>
                {{ client.gerant_nom or "‚Äî" }}
            </div>

            <div class="col-md-6 mb-2">
                <strong>Email :</strong><br>
                {{ client.email or "‚Äî" }}
            </div>

            <div class="col-md-6 mb-2">
                <strong>T√©l√©phone :</strong><br>
                {{ client.phone or "‚Äî" }}
            </div>

            <div class="col-md-6 mb-2">
                <strong>SIRET :</strong><br>
                {{ client.siret or "‚Äî" }}
            </div>

            <div class="col-md-6 mb-2">
                <strong>Adresse :</strong><br>
                {{ client.address or "‚Äî" }}
            </div>

        </div>
    </div>
</div>

<!-- ================= TABS ================= -->
<ul class="nav nav-tabs mb-4" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active"
                data-bs-toggle="tab"
                data-bs-target="#cotations"
                type="button"
                role="tab"
                aria-controls="cotations"
                aria-selected="true">
            Cotations
        </button>
    </li>

    <li class="nav-item" role="presentation">
        <button class="nav-link"
                data-bs-toggle="tab"
                data-bs-target="#documents"
                type="button"
                role="tab"
                aria-controls="documents"
                aria-selected="false">
            Documents
        </button>
    </li>

    <li class="nav-item" role="presentation">
        <button class="nav-link"
                data-bs-toggle="tab"
                data-bs-target="#updates"
                type="button"
                role="tab"
                aria-controls="updates"
                aria-selected="false">
            Mise √† jour
        </button>
    </li>
</ul>

<div class="tab-content">

    <!-- ================= ONGLET COTATIONS ================= -->
    <div class="tab-pane fade show active" id="cotations" role="tabpanel">

        {% if current_user
              and current_user.role in ['commercial', 'admin']
              and available_endpoints
              and 'create_cotation' in available_endpoints %}
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="mb-3">Nouvelle demande de cotation</h5>

                <form method="post"
                      action="{{ url_for('create_cotation', client_id=client.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

                    <div class="row g-3">

                        <div class="col-md-6">
                            <label class="form-label">Nom du dossier</label>
                            <input class="form-control" value="{{ client.name }}" disabled>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Commercial</label>
                            <input class="form-control" value="{{ current_user.username }}" disabled>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Date de n√©gociation *</label>
                            <input type="date" name="date_negociation" class="form-control" required>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Heure de n√©gociation</label>
                            <input type="time" name="heure_negociation" class="form-control">
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Type d‚Äô√©nergie *</label>
                            <select name="energie_type" class="form-control" required>
                                <option value="">‚Äî S√©lectionner ‚Äî</option>
                                <option value="electricite">√âlectricit√©</option>
                                <option value="gaz">Gaz</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Type de compteur</label>
                            <input name="type_compteur" class="form-control">
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">PDL / PCE *</label>
                            <input name="pdl_pce" class="form-control" required>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Date d‚Äô√©ch√©ance</label>
                            <input type="date" name="date_echeance" class="form-control">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Fournisseur actuel</label>
                            <input name="fournisseur_actuel" class="form-control">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Entreprise</label>
                            <input name="entreprise_nom" class="form-control" value="{{ client.name }}">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">SIRET</label>
                            <input name="siret" class="form-control" value="{{ client.siret or '' }}">
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Nom du signataire</label>
                            <input name="signataire_nom" class="form-control">
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">T√©l√©phone signataire</label>
                            <input name="signataire_tel" class="form-control">
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Email signataire</label>
                            <input type="email" name="signataire_email" class="form-control">
                        </div>

                        <div class="col-12">
                            <label class="form-label">Commentaire</label>
                            <textarea name="commentaire" class="form-control" rows="4"></textarea>
                        </div>

                    </div>

                    <div class="mt-4 text-end">
                        <button class="btn btn-warning">
                            Envoyer la demande de cotation
                        </button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}

        <!-- Historique cotations du client -->
        <div class="card">
            <div class="card-header">
                <strong>Historique des cotations</strong>
            </div>
            <div class="card-body">
                {% if client_cotations and client_cotations|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-sm align-middle">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Date cr√©ation</th>
                                    <th>Date n√©gociation</th>
                                    <th>√ânergie</th>
                                    <th>PDL/PCE</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for c in client_cotations %}
                                <tr>
                                    <td>#{{ c.id }}</td>
                                    <td>{{ c.date_creation or "‚Äî" }}</td>
                                    <td>{{ c.date_negociation or "‚Äî" }}</td>
                                    <td>{{ c.energie_type or "‚Äî" }}</td>
                                    <td>{{ c.pdl_pce or "‚Äî" }}</td>
                                    <td>{{ c.status or "nouvelle" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted mb-0">Aucune cotation pour ce dossier.</p>
                {% endif %}
            </div>
        </div>

    </div>

    <!-- ================= ONGLET DOCUMENTS ================= -->
    <div class="tab-pane fade" id="documents" role="tabpanel">

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <strong>Documents du client</strong>

                {% if available_endpoints and 'upload_client_document' in available_endpoints %}
                <span class="text-muted" style="font-size: 0.9rem;">Ajout au dossier</span>
                {% endif %}
            </div>

            <div class="card-body">
                {% if available_endpoints and 'upload_client_document' in available_endpoints %}
                <form method="post"
                      action="{{ url_for('upload_client_document', client_id=client.id) }}"
                      enctype="multipart/form-data"
                      class="mb-3">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

                    <div class="row g-2 align-items-center">
                        <div class="col-md-8">
                            <input type="file" name="file" class="form-control" required>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-primary">Uploader</button>
                        </div>
                    </div>
                </form>
                {% endif %}

                {% if documents and documents|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-sm align-middle">
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th style="width: 120px;">Taille</th>
                                    <th style="width: 220px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for d in documents %}
                                <tr>
                                    <td>{{ d.nom }}</td>
                                    <td>{{ d.taille or 0 }} o</td>
                                    <td>
                                        {% if available_endpoints and 'download_document' in available_endpoints %}
                                            <a class="btn btn-sm btn-outline-secondary"
                                               href="{{ url_for('download_document') }}?key={{ d.key | urlencode }}">
                                                T√©l√©charger
                                            </a>
                                        {% endif %}

                                        {% if available_endpoints and 'delete_document' in available_endpoints %}
                                        <form method="post"
                                              action="{{ url_for('delete_document') }}"
                                              style="display:inline;"
                                              onsubmit="return confirm('Supprimer ce document ?');">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                            <input type="hidden" name="key" value="{{ d.key }}">
                                            <button class="btn btn-sm btn-outline-danger">Supprimer</button>
                                        </form>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted mb-0">Aucun document pour ce dossier.</p>
                {% endif %}
            </div>
        </div>

    </div>

    <!-- ================= ONGLET MISE √Ä JOUR ================= -->
    <div class="tab-pane fade" id="updates" role="tabpanel">

        {% if current_user
              and current_user.role in ['commercial', 'admin']
              and available_endpoints
              and 'update_client' in available_endpoints %}
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="mb-3">Demander une mise √† jour</h5>

                <form method="post"
                      action="{{ url_for('update_client', client_id=client.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Date de mise √† jour *</label>
                            <input type="date" name="update_date" class="form-control" required>
                        </div>

                        <div class="col-md-8">
                            <label class="form-label">Commentaire</label>
                            <input type="text" name="update_commentaire" class="form-control">
                        </div>
                    </div>

                    <div class="mt-3 text-end">
                        <button class="btn btn-success">Envoyer la demande</button>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}

        <div class="card">
            <div class="card-header">
                <strong>Historique des mises √† jour</strong>
            </div>
            <div class="card-body">
                {% if updates and updates|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-sm align-middle">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Commentaire</th>
                                    <th>Lu</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for u in updates %}
                                <tr>
                                    <td>{{ u.update_date or "‚Äî" }}</td>
                                    <td>{{ u.commentaire or "‚Äî" }}</td>
                                    <td>
                                        {% if u.is_read %}
                                            ‚úÖ
                                        {% else %}
                                            ‚è≥
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted mb-0">Aucune mise √† jour enregistr√©e.</p>
                {% endif %}
            </div>
        </div>

    </div>

</div>

{% endblock %}

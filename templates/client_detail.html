{% extends "base.html" %}

{% block content %}

<style>
    .page-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .card {
        background: #ffffff;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }

    .card h3 {
        margin-bottom: 15px;
        font-size: 18px;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 15px;
    }

    .info-item span {
        display: block;
        font-size: 12px;
        color: #777;
    }

    .info-item strong {
        font-size: 14px;
    }

    form label {
        font-size: 13px;
        font-weight: 600;
        margin-top: 10px;
        display: block;
    }

    form input, form select, form textarea {
        width: 100%;
        padding: 8px 10px;
        margin-top: 4px;
        border-radius: 6px;
        border: 1px solid #ddd;
        font-size: 14px;
    }

    textarea {
        resize: vertical;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 15px;
    }

    .btn-primary {
        background: #f5b301;
        border: none;
        padding: 10px 18px;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        margin-top: 15px;
    }

    .btn-primary:hover {
        opacity: 0.9;
    }

    .doc-list {
        list-style: none;
        padding-left: 0;
        margin-top: 15px;
    }

    .doc-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
        border-bottom: 1px solid #eee;
        font-size: 14px;
        gap: 10px;
    }

    .doc-actions {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    .doc-actions a {
        text-decoration: none;
        font-size: 14px;
    }

    .doc-actions form {
        display: inline;
        margin: 0;
    }

    .doc-actions button {
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 14px;
        padding: 0;
    }

    h4 {
        margin-top: 18px;
        margin-bottom: 8px;
        font-size: 15px;
        border-left: 3px solid #f5b301;
        padding-left: 8px;
    }

    .muted {
        color: #777;
        font-size: 12px;
        margin-top: 6px;
    }
</style>

<!-- ================= TITRE ================= -->
<div class="page-title">
    <h1>{{ client.name }}</h1>
</div>

<!-- ================= INFOS CLIENT ================= -->
<div class="card">
    <h3>Informations client</h3>

    <div class="info-grid">
        <div class="info-item">
            <span>Commercial</span>
            {# Selon ton mod√®le: client.commercial_name, client.commercial, client.owner_name, etc. #}
            <strong>
                {{ client.commercial_name
                   or client.commercial
                   or client.created_by
                   or "‚Äî" }}
            </strong>
        </div>

        <div class="info-item">
            <span>Date de cr√©ation</span>
            <strong>{{ client.created_at or "‚Äî" }}</strong>
        </div>

        <div class="info-item">
            <span>Statut</span>
            <strong>{{ client.status or "‚Äî" }}</strong>
        </div>
    </div>
</div>

<!-- ================= DOCUMENTS ================= -->
<div class="card">
    <h3>Documents</h3>

    {# Upload documents: conserve ton endpoint si tu l'as. Ajout CSRF. #}
    <form method="POST"
          action="{{ url_for('upload_client_document', client_id=client.id) }}"
          enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <input type="file" name="documents" multiple>
        <button class="btn-primary" type="submit">Ajouter des documents</button>
        <div class="muted">Formats autoris√©s : PDF, images, Word/Excel/CSV.</div>
    </form>

    <ul class="doc-list">
        {% for doc in documents %}
            <li>
                <div>
                    {# Compat S3: doc.nom ; Compat DB: doc.filename ; fallback: doc.name #}
                    {{ doc.nom or doc.filename or doc.name or "Document" }}
                </div>

                <span class="doc-actions">
                    {# MODE S3 (recommand√© avec ton app.py): doc.url dispo #}
                    {% if doc.url %}
                        <a href="{{ doc.url }}" target="_blank" rel="noopener">Ouvrir</a>
                        {# suppression S3: tu dois avoir une route c√¥t√© backend.
                           On propose delete via POST si tu as un endpoint delete_client_document(key=...) #}
                        {% if doc.key %}
                            <form method="POST" action="{{ url_for('delete_client_document', client_id=client.id) }}"
                                  onsubmit="return confirm('Supprimer ce document ?')">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                <input type="hidden" name="key" value="{{ doc.key }}">
                                <button type="submit">üóë</button>
                            </form>
                        {% endif %}

                    {# MODE DB (ton template d'origine): open_document/delete_document via id #}
                    {% else %}
                        {% if doc.id %}
                            <a href="{{ url_for('open_document', document_id=doc.id) }}">Ouvrir</a>

                            {# IMPORTANT: supprimer en POST (s√©curit√©). Si ton backend est encore en GET,
                               je te conseille fortement de passer en POST et je te fournirai la route. #}
                            <form method="POST"
                                  action="{{ url_for('delete_document', document_id=doc.id) }}"
                                  onsubmit="return confirm('Supprimer ce document ?')">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                <button type="submit">üóë</button>
                            </form>
                        {% else %}
                            <span class="muted">Lien indisponible</span>
                        {% endif %}
                    {% endif %}
                </span>
            </li>
        {% else %}
            <li>Aucun document</li>
        {% endfor %}
    </ul>
</div>

<!-- ================= DEMANDE DE COTATION ================= -->
<div class="card">
    <h3>Nouvelle demande de cotation</h3>

    {# IMPORTANT:
       - "open_cotation" dans ton app.py (que j'ai vu) est une route GET /cotations/<id>
         donc ce n'est pas la bonne action pour cr√©er.
       - Ici, on cible un endpoint de cr√©ation.
       Remplace 'create_cotation' par le nom exact de TA route de cr√©ation si diff√©rent.
    #}
    <form method="POST"
          action="{{ url_for('create_cotation', client_id=client.id) }}">

        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

        {# Liaison au commercial:
           - si tu stockes created_by c√¥t√© cotation: le backend prendra session.user.id
           - si tu passes explicitement owner_id/commercial_id: tu peux ajouter un hidden.
           Je le laisse optionnel, √† activer si ton backend l'attend.
        #}
        {# <input type="hidden" name="commercial_id" value="{{ current_user.id }}"> #}

        <h4>N√©gociation</h4>
        <div class="form-grid">
            <div>
                <label for="date_negociation">Date de n√©gociation</label>
                <input type="date" id="date_negociation" name="date_negociation">
            </div>
        </div>

        <h4>Signataire</h4>
        <div class="form-grid">
            <div>
                <label for="signataire_nom">Nom</label>
                <input type="text" id="signataire_nom" name="signataire_nom" autocomplete="name">
            </div>
            <div>
                <label for="signataire_tel">T√©l√©phone</label>
                <input type="text" id="signataire_tel" name="signataire_tel" autocomplete="tel">
            </div>
            <div>
                <label for="signataire_email">Email</label>
                <input type="email" id="signataire_email" name="signataire_email" autocomplete="email">
            </div>
        </div>

        <h4>Entreprise</h4>
        <div class="form-grid">
            <div>
                <label for="entreprise_nom">Nom de l‚Äôentreprise</label>
                <input type="text" id="entreprise_nom" name="entreprise_nom">
            </div>
            <div>
                <label for="siret">SIRET</label>
                <input type="text" id="siret" name="siret" inputmode="numeric" placeholder="14 chiffres">
            </div>
        </div>

        <h4>√ânergie</h4>
        <div class="form-grid">
            <div>
                <label for="energie_type">Type d‚Äô√©nergie</label>
                <select id="energie_type" name="energie_type">
                    <option value="">‚Äî S√©lectionner ‚Äî</option>
                    <option value="electricite">√âlectricit√©</option>
                    <option value="gaz">Gaz</option>
                </select>
            </div>
            <div>
                <label for="pdl_pce">Num√©ro PDL / PCE</label>
                <input type="text" id="pdl_pce" name="pdl_pce">
            </div>
        </div>

        <h4>Contrat actuel</h4>
        <div class="form-grid">
            <div>
                <label for="date_echeance">Date d‚Äô√©ch√©ance</label>
                <input type="date" id="date_echeance" name="date_echeance">
            </div>
            <div>
                <label for="fournisseur_actuel">Fournisseur actuel</label>
                <input type="text" id="fournisseur_actuel" name="fournisseur_actuel">
            </div>
        </div>

        <h4>Commentaires</h4>
        <textarea name="commentaire" rows="4" placeholder="Pr√©cisions sur le besoin, volumes, conditions, contraintes..."></textarea>

        {# Historisation / mises √† jour:
           On ne met PAS des champs update_* dans le formulaire de cr√©ation,
           sinon on m√©lange cr√©ation et update.
           La mise √† jour/historique doit √™tre un flux s√©par√© (√©dition cotation).
        #}

        <button class="btn-primary" type="submit">
            Envoyer la demande de cotation
        </button>

        <div class="muted">
            La demande sera rattach√©e au client et au commercial connect√©. Vous pourrez la modifier et suivre l‚Äôhistorique.
        </div>
    </form>
</div>

{% endblock %}

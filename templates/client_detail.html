{% extends "base.html" %}
{% block title %}Dossier client{% endblock %}

{% block content %}

<!-- ================= PAGE HEADER ================= -->
<div class="page-header mb-4 d-flex justify-content-between align-items-center">
    <div>
        <h1>Dossier client</h1>
        <p class="text-muted mb-0">{{ client.name }}</p>
    </div>

    {% if current_user
          and current_user.role == 'admin'
          and (available_endpoints is not defined or 'delete_client' in available_endpoints) %}
    <form method="post"
          action="{{ url_for('delete_client', client_id=client.id) }}"
          onsubmit="return confirm('SUPPRIMER DÃ‰FINITIVEMENT ce dossier client ?');">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <button type="submit" class="btn btn-danger">
            Supprimer le dossier client
        </button>
    </form>
    {% endif %}
</div>

<!-- ================= STATUT DOSSIER ================= -->
{% if current_user
      and (current_user.role == "admin" or current_user.id == client.owner_id)
      and (available_endpoints is not defined or 'update_client_status' in available_endpoints) %}
<div class="card mb-4">
    <div class="card-header">
        <strong>Statut du dossier</strong>
    </div>
    <div class="card-body" style="max-width:300px;">
        <form method="post"
              action="{{ url_for('update_client_status', client_id=client.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

            <select name="status"
                    class="form-select"
                    onchange="this.form.submit()">
                <option value="en_cours" {% if client.status == "en_cours" %}selected{% endif %}>
                    ðŸŸ¡ En cours
                </option>
                <option value="gagne" {% if client.status == "gagne" %}selected{% endif %}>
                    ðŸŸ¢ GagnÃ©
                </option>
                <option value="perdu" {% if client.status == "perdu" %}selected{% endif %}>
                    ðŸ”´ Perdu
                </option>
            </select>
        </form>
    </div>
</div>
{% endif %}

<!-- ================= FICHE ENTREPRISE ================= -->
<div class="card mb-4">
    <div class="card-header">
        <strong>Fiche entreprise</strong>
    </div>
    <div class="card-body">
        <div class="row">

            <div class="col-md-6 mb-2">
                <strong>Entreprise :</strong><br>
                {{ client.name }}
            </div>

            <div class="col-md-6 mb-2">
                <strong>Nom du gÃ©rant :</strong><br>
                {{ client.gerant_nom or "â€”" }}
            </div>

            <div class="col-md-6 mb-2">
                <strong>Email :</strong><br>
                {{ client.email or "â€”" }}
            </div>

            <div class="col-md-6 mb-2">
                <strong>TÃ©lÃ©phone :</strong><br>
                {{ client.phone or "â€”" }}
            </div>

            <div class="col-md-6 mb-2">
                <strong>SIRET :</strong><br>
                {{ client.siret or "â€”" }}
            </div>

            <div class="col-md-6 mb-2">
                <strong>Adresse :</strong><br>
                {{ client.address or "â€”" }}
            </div>

        </div>
    </div>
</div>

<!-- ================= TABS ================= -->
<ul class="nav nav-tabs mb-4" role="tablist">
    <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#cotations" type="button">
            Cotations
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#documents" type="button">
            Documents
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#updates" type="button">
            Mise Ã  jour
        </button>
    </li>
</ul>

<div class="tab-content">

<!-- ================= ONGLET COTATIONS ================= -->
<div class="tab-pane fade show active" id="cotations">
{% if current_user
      and current_user.role in ['commercial', 'admin']
      and (available_endpoints is not defined or 'create_cotation' in available_endpoints) %}
<div class="card">
    <div class="card-body">
        <h5 class="mb-3">Nouvelle demande de cotation</h5>

        <form method="post"
              action="{{ url_for('create_cotation', client_id=client.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

            <div class="row g-3">

                <div class="col-md-6">
                    <label class="form-label">Nom du dossier</label>
                    <input class="form-control" value="{{ client.name }}" disabled>
                </div>

                <div class="col-md-6">
                    <label class="form-label">Commercial</label>
                    <input class="form-control" value="{{ current_user.username }}" disabled>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Date de nÃ©gociation *</label>
                    <input type="date" name="date_negociation" class="form-control" required>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Heure de nÃ©gociation</label>
                    <input type="time" name="heure_negociation" class="form-control">
                </div>

                <div class="col-md-4">
                    <label class="form-label">Type dâ€™Ã©nergie *</label>
                    <select name="energie_type" class="form-control" required>
                        <option value="">â€” SÃ©lectionner â€”</option>
                        <option value="electricite">Ã‰lectricitÃ©</option>
                        <option value="gaz">Gaz</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Type de compteur</label>
                    <input name="type_compteur" class="form-control">
                </div>

                <div class="col-md-4">
                    <label class="form-label">PDL / PCE *</label>
                    <input name="pdl_pce" class="form-control" required>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Date dâ€™Ã©chÃ©ance</label>
                    <input type="date" name="date_echeance" class="form-control">
                </div>

                <div class="col-md-6">
                    <label class="form-label">Fournisseur actuel</label>
                    <input name="fournisseur_actuel" class="form-control">
                </div>

                <div class="col-md-6">
                    <label class="form-label">Entreprise</label>
                    <input name="entreprise_nom" class="form-control" value="{{ client.name }}">
                </div>

                <div class="col-md-6">
                    <label class="form-label">SIRET</label>
                    <input name="siret" class="form-control" value="{{ client.siret or '' }}">
                </div>

                <div class="col-md-4">
                    <label class="form-label">Nom du signataire</label>
                    <input name="signataire_nom" class="form-control">
                </div>

                <div class="col-md-4">
                    <label class="form-label">TÃ©lÃ©phone signataire</label>
                    <input name="signataire_tel" class="form-control">
                </div>

                <div class="col-md-4">
                    <label class="form-label">Email signataire</label>
                    <input type="email" name="signataire_email" class="form-control">
                </div>

                <div class="col-12">
                    <label class="form-label">Commentaire</label>
                    <textarea name="commentaire" class="form-control" rows="4"></textarea>
                </div>

            </div>

            <div class="mt-4 text-end">
                <button class="btn btn-warning">
                    Envoyer la demande de cotation
                </button>
            </div>
        </form>
    </div>
</div>
{% endif %}
</div>

<!-- Les autres onglets (Documents / Updates) restent strictement inchangÃ©s -->

</div>
{% endblock %}

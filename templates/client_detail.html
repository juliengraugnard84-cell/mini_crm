{% extends "base.html" %}
{% block title %}Dossier client{% endblock %}

{% block content %}

<!-- ================= PAGE HEADER ================= -->
<div class="page-header mb-4 d-flex justify-content-between align-items-center">
    <div>
        <h1>Dossier client</h1>
        <p class="text-muted mb-0">{{ client.name }}</p>
    </div>

    {% if current_user and current_user.role == 'admin' %}
    <form method="post"
          action="{{ url_for('delete_client', client_id=client.id) }}"
          onsubmit="return confirm('SUPPRIMER DÃ‰FINITIVEMENT ce dossier client ?');">
        <button type="submit" class="btn btn-danger">
            Supprimer le dossier client
        </button>
    </form>
    {% endif %}
</div>

<!-- ================= STATUT DOSSIER ================= -->
{% if current_user.role == "admin" or current_user.id == client.owner_id %}
<div class="card mb-4">
    <div class="card-header">
        <strong>Statut du dossier</strong>
    </div>
    <div class="card-body" style="max-width:300px;">
        <form method="POST"
              action="{{ url_for('update_client_status', client_id=client.id) }}">

            <select name="status"
                    class="form-select"
                    onchange="this.form.submit()">

                <option value="en_cours"
                        {% if client.status == "en_cours" %}selected{% endif %}>
                    ðŸŸ¡ En cours
                </option>

                <option value="gagne"
                        {% if client.status == "gagne" %}selected{% endif %}>
                    ðŸŸ¢ GagnÃ©
                </option>

                <option value="perdu"
                        {% if client.status == "perdu" %}selected{% endif %}>
                    ðŸ”´ Perdu
                </option>

            </select>
        </form>
    </div>
</div>
{% endif %}

<!-- ================= FICHE ENTREPRISE ================= -->
<div class="card mb-4">
    <div class="card-header">
        <strong>Fiche entreprise</strong>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6 mb-2"><strong>Entreprise :</strong><br>{{ client.name }}</div>
            <div class="col-md-6 mb-2"><strong>Email :</strong><br>{{ client.email or "â€”" }}</div>
            <div class="col-md-6 mb-2"><strong>TÃ©lÃ©phone :</strong><br>{{ client.phone or "â€”" }}</div>
            <div class="col-md-6 mb-2"><strong>SIRET :</strong><br>{{ client.siret or "â€”" }}</div>
            <div class="col-md-6 mb-2"><strong>Adresse :</strong><br>{{ client.address or "â€”" }}</div>
        </div>
    </div>
</div>

<!-- ================= TABS ================= -->
<ul class="nav nav-tabs mb-4" role="tablist">
    <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#cotations" type="button">
            Cotations
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#documents" type="button">
            Documents
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#updates" type="button">
            Mise Ã  jour
        </button>
    </li>
</ul>

<div class="tab-content">

<!-- ================= ONGLET COTATIONS ================= -->
<div class="tab-pane fade show active" id="cotations">

{% if current_user and current_user.role in ['commercial', 'admin'] %}
<div class="card">
    <div class="card-body">

        <h5 class="mb-3">Nouvelle demande de cotation</h5>

        <form method="post" action="{{ url_for('create_cotation', client_id=client.id) }}">

            <div class="row g-3">

                <div class="col-md-6">
                    <label class="form-label">Nom du dossier</label>
                    <input class="form-control" value="{{ client.name }}" disabled>
                </div>

                <div class="col-md-6">
                    <label class="form-label">Commercial</label>
                    <input class="form-control" value="{{ current_user.username }}" disabled>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Type dâ€™Ã©nergie *</label>
                    <select name="energie_type" class="form-control" required>
                        <option value="">â€” SÃ©lectionner â€”</option>
                        <option value="electricite">Ã‰lectricitÃ©</option>
                        <option value="gaz">Gaz</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label">PDL / PCE *</label>
                    <input type="text" name="pdl_pce" class="form-control" required>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Fournisseur actuel</label>
                    <input type="text" name="fournisseur_actuel" class="form-control">
                </div>

                <div class="col-12">
                    <label class="form-label">Commentaire</label>
                    <textarea name="commentaire" class="form-control" rows="4"></textarea>
                </div>

            </div>

            <div class="mt-4 text-end">
                <button class="btn btn-warning">
                    Envoyer la demande de cotation
                </button>
            </div>
        </form>

    </div>
</div>
{% endif %}
</div>

<!-- ================= ONGLET DOCUMENTS ================= -->
<div class="tab-pane fade" id="documents">
<form method="post"
      enctype="multipart/form-data"
      action="{{ url_for('upload_client_document', client_id=client.id) }}"
      class="mb-3">
    <div class="d-flex gap-2 flex-wrap">
        <input type="file" name="file" class="form-control" required style="max-width:360px;">
        <button class="btn btn-primary btn-sm">Ajouter un document</button>
    </div>
</form>

{% if documents %}
<ul class="list-group">
{% for d in documents %}
<li class="list-group-item d-flex justify-content-between align-items-center">
{{ d.nom }}
{% if d.url %}
<a href="{{ d.url }}" target="_blank" class="btn btn-sm btn-outline-primary">Ouvrir</a>
{% endif %}
</li>
{% endfor %}
</ul>
{% else %}
<p class="text-muted">Aucun document.</p>
{% endif %}
</div>

<!-- ================= ONGLET MISE Ã€ JOUR ================= -->
<div class="tab-pane fade" id="updates">
{% if can_request_update %}
<form method="post" action="{{ url_for('update_client', client_id=client.id) }}">
<div class="row g-3 mb-3">
<div class="col-md-4">
<label class="form-label">Date de mise Ã  jour *</label>
<input type="date" name="update_date" class="form-control" required>
</div>
<div class="col-md-8">
<label class="form-label">Commentaire</label>
<textarea name="update_commentaire" class="form-control" rows="3"></textarea>
</div>
</div>
<button type="submit" class="btn btn-warning">Demander une mise Ã  jour</button>
</form>
{% endif %}
<hr>
{% if updates %}
{% for u in updates %}
<div class="border rounded p-2 mb-2">
<strong>{{ u.commercial_name }}</strong>
<small class="text-muted"> â€” {{ format_date(u.update_date) }}</small>
<div>{{ u.commentaire or "â€”" }}</div>
</div>
{% endfor %}
{% else %}
<p class="text-muted">Aucune mise Ã  jour.</p>
{% endif %}
</div>

</div>
{% endblock %}

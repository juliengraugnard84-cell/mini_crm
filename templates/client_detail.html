{% extends "base.html" %}
{% block title %}Client ‚Äî {{ client.name }}{% endblock %}

{% block content %}

<!-- ================= HEADER ================= -->
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
    <h1>{{ client.name }}</h1>

    <div class="actions-row">
        <a href="{{ url_for('edit_client', client_id=client.id) }}"
           class="btn btn-secondary">
            ‚úè Modifier
        </a>

        <form method="post"
              action="{{ url_for('delete_client', client_id=client.id) }}"
              onsubmit="return confirm('Supprimer d√©finitivement ce client ?');">
            <button type="submit" class="btn btn-danger">
                üóë Supprimer
            </button>
        </form>
    </div>
</div>

<!-- ================= INFOS CLIENT ================= -->
<div class="card">
    <h5>Informations client</h5>

    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;">

        <div>
            <div class="form-label">Email</div>
            {{ client.email or "‚Äî" }}
        </div>

        <div>
            <div class="form-label">T√©l√©phone</div>
            {{ client.phone or "‚Äî" }}
        </div>

        <div>
            <div class="form-label">Commercial</div>
            {{ client.commercial or "‚Äî" }}
        </div>

        <div>
            <div class="form-label">Statut</div>

            {% set s = (client.status or '').lower() %}
            {% if s == 'sign√©' %}
                <span class="badge badge-success">Sign√©</span>
            {% elif s == 'en cours' %}
                <span class="badge badge-warning">En cours</span>
            {% elif s == 'perdu' %}
                <span class="badge badge-danger">Perdu</span>
            {% else %}
                <span class="badge badge-info">Cotation</span>
            {% endif %}
        </div>

    </div>

    {% if client.notes %}
    <div style="margin-top:18px;">
        <div class="form-label">Notes</div>
        <p>{{ client.notes }}</p>
    </div>
    {% endif %}
</div>

<!-- ================= COTATIONS ================= -->
<div class="card">
    <h5>Demandes de cotation</h5>

    {% if cotations %}
        {% for cot in cotations %}
        <div class="list-group-item"
             style="display:flex;justify-content:space-between;align-items:center;gap:16px;">
            <div>
                <strong>{{ cot.energie_type or "‚Äî" }}</strong><br>
                <small class="text-muted">
                    Cr√©√©e le {{ cot.date_creation[:10] }}
                </small>
            </div>

            <span class="badge badge-info">Nouvelle</span>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <strong>Aucune cotation</strong>
            Aucune demande de cotation pour ce client.
        </div>
    {% endif %}

    <!-- ===== Nouvelle cotation ===== -->
    <form method="post"
          action="{{ url_for('create_cotation', client_id=client.id) }}"
          style="margin-top:20px;">

        <h5>Nouvelle demande de cotation</h5>

        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;">

            <div>
                <label class="form-label">Type d‚Äô√©nergie</label>
                <select name="energie_type" class="form-control">
                    <option value="√©lectricit√©">√âlectricit√©</option>
                    <option value="gaz">Gaz</option>
                </select>
            </div>

            <div>
                <label class="form-label">Date d‚Äô√©ch√©ance</label>
                <input type="date" name="date_echeance" class="form-control">
            </div>

            <div>
                <label class="form-label">PDL / PCE</label>
                <input type="text" name="pdl_pce" class="form-control">
            </div>

            <div>
                <label class="form-label">Fournisseur actuel</label>
                <input type="text" name="fournisseur_actuel" class="form-control">
            </div>

        </div>

        <div style="margin-top:16px;">
            <label class="form-label">Commentaire</label>
            <textarea name="commentaire" class="form-control" rows="3"></textarea>
        </div>

        <button type="submit"
                class="btn btn-primary"
                style="margin-top:16px;">
            ‚ûï Ajouter la cotation
        </button>
    </form>
</div>

<!-- ================= DOCUMENTS CLIENT ================= -->
<div class="card">
    <h5>Documents</h5>

    <!-- Upload document -->
    <form method="post"
          action="{{ url_for('upload_client_document', client_id=client.id) }}"
          enctype="multipart/form-data"
          style="margin-bottom:16px;display:flex;gap:12px;align-items:center;">

        <input type="file" name="file" required>
        <button type="submit" class="btn btn-primary">
            ‚ûï Ajouter un document
        </button>
    </form>

    {% if documents %}
        {% for d in documents %}
        <div class="list-group-item"
             style="display:flex;justify-content:space-between;align-items:center;gap:16px;">

            <span>{{ d.nom }}</span>

            <div style="display:flex;gap:8px;">
                <a href="{{ d.url }}" target="_blank" class="btn btn-secondary">
                    Ouvrir
                </a>

                <form method="post"
                      action="{{ url_for('delete_client_document', client_id=client.id) }}"
                      onsubmit="return confirm('Supprimer ce document ?');">
                    <input type="hidden" name="key" value="{{ d.key }}">
                    <button type="submit" class="btn btn-danger">
                        Supprimer
                    </button>
                </form>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <strong>Aucun document</strong>
            Aucun document associ√© √† ce client.
        </div>
    {% endif %}
</div>

{% endblock %}

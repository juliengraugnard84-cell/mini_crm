{% extends "base.html" %}

{% block title %}Dossier client{% endblock %}

{% block content %}

<!-- ================= PAGE HEADER ================= -->
<div class="page-header mb-4 d-flex justify-content-between align-items-center">
    <div>
        <h1>Dossier client</h1>
        <p class="text-muted mb-0">{{ client.name }}</p>
    </div>

    {% if current_user and current_user.role == 'admin' %}
    <form method="post"
          action="{{ url_for('delete_client', client_id=client.id) }}"
          onsubmit="return confirm('SUPPRIMER DÉFINITIVEMENT ce dossier client ?');">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <button class="btn btn-danger">
            Supprimer le dossier client
        </button>
    </form>
    {% endif %}
</div>

<!-- ================= FICHE ENTREPRISE ================= -->
<div class="card mb-4">
    <div class="card-header">
        <strong>Fiche entreprise</strong>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6 mb-2"><strong>Entreprise :</strong><br>{{ client.name }}</div>
            <div class="col-md-6 mb-2"><strong>Gérant :</strong><br>{{ client.gerant_nom or "—" }}</div>
            <div class="col-md-6 mb-2"><strong>Email :</strong><br>{{ client.email or "—" }}</div>
            <div class="col-md-6 mb-2"><strong>Téléphone :</strong><br>{{ client.phone or "—" }}</div>
            <div class="col-md-6 mb-2"><strong>SIRET :</strong><br>{{ client.siret or "—" }}</div>
            <div class="col-md-6 mb-2"><strong>Adresse :</strong><br>{{ client.address or "—" }}</div>
        </div>
    </div>
</div>

<!-- ================= TABS ================= -->
<ul class="nav nav-tabs mb-4" role="tablist">
    <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#cotations">Cotations</button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#documents">Documents</button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#updates">Mise à jour</button>
    </li>
</ul>

<div class="tab-content">

<!-- ================= ONGLET COTATIONS ================= -->
<div class="tab-pane fade show active" id="cotations">
{% if current_user and current_user.role in ['commercial', 'admin'] %}
<div class="card mb-4">
    <div class="card-body">
        <h5 class="mb-3">Nouvelle demande de cotation</h5>

        <form method="post" action="{{ url_for('create_cotation', client_id=client.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

            <!-- ⚠️ FORMULAIRE SIMPLIFIÉ INTENTIONNEL
                 Le détail complet est géré dans la page cotation -->
            <div class="text-end">
                <button class="btn btn-primary">
                    Créer la demande
                </button>
            </div>
        </form>
    </div>
</div>
{% endif %}
</div>

<!-- ================= ONGLET DOCUMENTS ================= -->
<div class="tab-pane fade" id="documents">
<div class="card mb-4">
    <div class="card-body">
        <h5 class="mb-3">Documents du client</h5>

        <!-- Upload classique -->
        <form method="post"
              enctype="multipart/form-data"
              action="{{ url_for('upload_client_document', client_id=client.id) }}"
              class="mb-3">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <input type="file" name="file" class="form-control mb-2">
            <button class="btn btn-secondary">Ajouter un document</button>
        </form>

        <!-- Dropzone -->
        <form
            action="{{ url_for('upload_client_document', client_id=client.id) }}"
            method="post"
            enctype="multipart/form-data"
            class="dropzone border rounded p-3"
            id="clientDocumentsDropzone">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <div class="dz-message text-center text-muted">
                <strong>Glissez-déposez vos documents ici</strong>
            </div>
        </form>

        <hr>

        {% if documents %}
        <ul class="list-group">
            {% for doc in documents %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>{{ doc.nom }}</span>

                <div class="d-flex gap-2">
                    {% if doc.url %}
                    <a href="{{ doc.url }}" target="_blank" class="btn btn-sm btn-primary">
                        Télécharger
                    </a>
                    {% endif %}

                    {% if current_user and current_user.role == 'admin' %}
                    <button
                        type="button"
                        class="btn btn-sm btn-outline-danger js-delete-doc"
                        data-delete-url="{{ url_for('delete_document', key=doc.key) }}"
                        data-doc-name="{{ doc.nom|e }}">
                        Supprimer
                    </button>
                    {% endif %}
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="text-muted">Aucun document.</p>
        {% endif %}
    </div>
</div>
</div>

<!-- ================= ONGLET MISE À JOUR ================= -->
<div class="tab-pane fade" id="updates">
<div class="card mb-4">
    <div class="card-body">
        <h5 class="mb-3">Demande de mise à jour</h5>

        {% if can_request_update %}
        <form method="post" action="{{ url_for('update_client', client_id=client.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

            <input type="date"
                   name="update_date"
                   class="form-control mb-2"
                   required>

            <textarea
                name="update_commentaire"
                class="form-control mb-3"
                placeholder="Commentaire (optionnel)"></textarea>

            <button class="btn btn-primary">Envoyer</button>
        </form>
        {% else %}
        <p class="text-muted">Aucune action disponible.</p>
        {% endif %}
    </div>
</div>
</div>

</div>

{% endblock %}

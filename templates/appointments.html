{% extends "base.html" %}
{% block title %}Rendez-vous{% endblock %}
{% block content %}

<div class="container mt-4">

    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="fw-bold d-flex align-items-center m-0">
            <i class="bi bi-calendar-event me-2"></i> Calendrier / Rendez-vous
        </h1>

        <a class="btn btn-primary btn-lg shadow-sm" href="{{ url_for('new_appointment') }}">
            <i class="bi bi-plus-lg me-2"></i> Nouveau RDV
        </a>
    </div>

    <!-- ================= MINI CALENDRIER ================= -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">

            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="fw-semibold m-0 d-flex align-items-center">
                    <i class="bi bi-calendar-week me-2"></i> Mini calendrier
                </h4>

                <div class="d-flex align-items-center gap-2">
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="prev-month">
                        <i class="bi bi-chevron-left"></i>
                    </button>

                    <span id="mini-cal-title" class="fw-semibold"></span>

                    <button type="button" class="btn btn-outline-secondary btn-sm" id="next-month">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>

            <table class="table table-bordered text-center mini-calendar bg-white mb-2">
                <thead class="table-light">
                    <tr>
                        <th>Lu</th><th>Ma</th><th>Me</th><th>Je</th>
                        <th>Ve</th><th>Sa</th><th>Di</th>
                    </tr>
                </thead>
                <tbody id="mini-cal-body"></tbody>
            </table>

            <p class="text-muted small fst-italic">
                Cliquez sur un jour pour filtrer les rendez-vous ci-dessous.
            </p>

        </div>
    </div>

    <!-- ================= FILTRE PAR DATE ================= -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">

            <form method="get" class="row g-3 align-items-end">

                <div class="col-md-4">
                    <label class="form-label fw-semibold">Filtrer par date :</label>
                    <input type="date"
                           name="date"
                           class="form-control"
                           value="{{ request.args.get('date', '') }}">
                </div>

                <div class="col-md-4 d-flex gap-2">
                    <button class="btn btn-dark shadow-sm">
                        <i class="bi bi-funnel me-1"></i> Filtrer
                    </button>

                    <a href="{{ url_for('list_appointments') }}"
                       class="btn btn-outline-secondary shadow-sm">
                        <i class="bi bi-arrow-counterclockwise me-1"></i> Réinitialiser
                    </a>
                </div>

            </form>

        </div>
    </div>

    <!-- ================= TABLEAU DES RDV ================= -->
    <div class="card shadow-sm border-0">
        <div class="card-body p-0">

            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Date</th>
                        <th>Heure</th>
                        <th>Titre</th>
                        <th>Client</th>
                        <th>Notes</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>

                <tbody>
                {% for rdv in appointments %}
                    <tr>
                        <td class="fw-semibold">{{ rdv.date.strftime("%d/%m/%Y") }}</td>
                        <td>{{ rdv.time.strftime("%H:%M") }}</td>
                        <td class="fw-semibold">{{ rdv.title }}</td>
                        <td>{{ rdv.client_name }}</td>
                        <td class="text-muted">{{ rdv.notes or "-" }}</td>

                        <td class="text-end">

                            <a href="{{ url_for('edit_appointment', appointment_id=rdv.id) }}"
                               class="btn btn-sm btn-outline-success"
                               title="Modifier">
                                <i class="bi bi-pencil"></i>
                            </a>

                            <form method="post"
                                  action="{{ url_for('delete_appointment', appointment_id=rdv.id) }}"
                                  class="d-inline"
                                  onsubmit="return confirm('Supprimer ce rendez-vous ?');">
                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Supprimer">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>

                        </td>
                    </tr>

                {% else %}
                    <tr>
                        <td colspan="6" class="text-center py-4 text-muted fst-italic">
                            Aucun rendez-vous.
                        </td>
                    </tr>
                {% endfor %}
                </tbody>

            </table>

        </div>
    </div>

</div>

<!-- ================= JS MINI CALENDRIER ================= -->
<script>
document.addEventListener('DOMContentLoaded', function() {

    const titleEl = document.getElementById('mini-cal-title');
    const bodyEl = document.getElementById('mini-cal-body');
    const prevBtn = document.getElementById('prev-month');
    const nextBtn = document.getElementById('next-month');

    const selectedDateStr = "{{ request.args.get('date', '') }}";
    let current = new Date();

    if (selectedDateStr) {
        const parts = selectedDateStr.split("-");
        if (parts.length === 3) {
            const y = parseInt(parts[0], 10);
            const m = parseInt(parts[1], 10) - 1;
            if (!isNaN(y) && !isNaN(m)) {
                current = new Date(y, m, 1);
            }
        }
    }

    const pad = (n) => (n < 10 ? "0" + n : "" + n);

    function renderCalendar() {
        const year = current.getFullYear();
        const month = current.getMonth();

        const monthNames = [
            "Janvier","Février","Mars","Avril","Mai","Juin",
            "Juillet","Août","Septembre","Octobre","Novembre","Décembre"
        ];
        titleEl.textContent = monthNames[month] + " " + year;

        bodyEl.innerHTML = "";

        const firstDay = new Date(year, month, 1);
        let startWeekday = firstDay.getDay();
        startWeekday = (startWeekday + 6) % 7;

        const daysInMonth = new Date(year, month + 1, 0).getDate();
        let row = document.createElement("tr");

        for (let i = 0; i < startWeekday; i++) {
            row.appendChild(document.createElement("td"));
        }

        for (let day = 1; day <= daysInMonth; day++) {

            if (row.children.length === 7) {
                bodyEl.appendChild(row);
                row = document.createElement("tr");
            }

            const td = document.createElement("td");
            td.textContent = day;
            td.classList.add("py-2", "cursor-pointer");

            const dateStr = year + "-" + pad(month + 1) + "-" + pad(day);
            td.dataset.date = dateStr;

            if (selectedDateStr === dateStr) {
                td.classList.add("bg-primary", "text-white", "fw-bold");
            }

            td.addEventListener("click", () => {
                window.location.href = "{{ url_for('list_appointments') }}" + "?date=" + dateStr;
            });

            row.appendChild(td);
        }

        if (row.children.length > 0) {
            while (row.children.length < 7) {
                row.appendChild(document.createElement("td"));
            }
            bodyEl.appendChild(row);
        }
    }

    prevBtn.addEventListener("click", () => {
        current.setMonth(current.getMonth() - 1);
        renderCalendar();
    });

    nextBtn.addEventListener("click", () => {
        current.setMonth(current.getMonth() + 1);
        renderCalendar();
    });

    renderCalendar();
});
</script>

{% endblock %}

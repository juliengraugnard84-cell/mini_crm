{% extends "base.html" %}
{% block title %}Tableau de bord{% endblock %}

{% block content %}

<style>
.kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 36px;
}
.kpi-tile {
    background: #ffffff;
    border-radius: 14px;
    padding: 20px 22px;
    box-shadow: 0 6px 18px rgba(0,0,0,.05);
    border-left: 5px solid #e5e7eb;
}
.kpi-label {
    font-size: .85rem;
    color: #6b7280;
    margin-bottom: 6px;
}
.kpi-value {
    font-size: 2rem;
    font-weight: 700;
    color: #111827;
}
.page-header h1 {
    font-weight: 800;
}
.pipeline-card {
    background: #f9fafb;
    border-radius: 10px;
    padding: 12px 14px;
    transition: all .15s ease;
}
.pipeline-card:hover {
    background: #eef2ff;
}
</style>

{% if current_user and current_user.role == 'admin' %}

<!-- ================= DASHBOARD ADMIN ================= -->

<div class="page-header mb-4">
    <div class="text-muted small mb-1">Admin connectÃ©</div>
    <h1>Tableau de bord</h1>
    <p class="text-muted">Vue dâ€™ensemble de lâ€™activitÃ©</p>
</div>

<div class="kpi-grid">
    <div class="kpi-tile">
        <div class="kpi-label">Dossiers clients</div>
        <div class="kpi-value">{{ total_clients or 0 }}</div>
    </div>
    <div class="kpi-tile">
        <div class="kpi-label">Chiffre dâ€™affaires total</div>
        <div class="kpi-value">{{ "%.2f"|format(total_ca) }} â‚¬</div>
    </div>
    <div class="kpi-tile">
        <div class="kpi-label">Documents stockÃ©s</div>
        <div class="kpi-value">{{ total_docs or 0 }}</div>
    </div>
    <div class="kpi-tile" style="border-left-color:#ef4444;">
        <div class="kpi-label">Nouvelles cotations</div>
        <div class="kpi-value">{{ unread_cotations or 0 }}</div>
    </div>
</div>

{% set p = pipeline if pipeline is defined else {'en_cours':0,'gagnes':0,'perdus':0} %}

<h3 class="mb-3">Pipeline global</h3>
<div class="kpi-grid">
    <div class="kpi-tile">ðŸŸ¡ En cours<br><strong>{{ p.en_cours }}</strong></div>
    <div class="kpi-tile">ðŸŸ¢ GagnÃ©s<br><strong>{{ p.gagnes }}</strong></div>
    <div class="kpi-tile">ðŸ”´ Perdus<br><strong>{{ p.perdus }}</strong></div>
</div>

{% else %}

<!-- ================= DASHBOARD COMMERCIAL ================= -->

<div class="page-header mb-4">
    <div class="text-muted small mb-1">Commercial connectÃ©</div>
    <h1>Mon tableau de bord</h1>
    <p class="text-muted">Suivi de mon activitÃ©</p>
</div>

<div class="kpi-grid">
    <div class="kpi-tile">
        <div class="kpi-label">Mes dossiers</div>
        <div class="kpi-value">{{ commercial_stats.nb_clients }}</div>
    </div>
    <div class="kpi-tile">
        <div class="kpi-label">CA total</div>
        <div class="kpi-value">{{ "%.2f"|format(commercial_stats.ca_total) }} â‚¬</div>
    </div>
    <div class="kpi-tile">
        <div class="kpi-label">CA du mois</div>
        <div class="kpi-value">{{ "%.2f"|format(commercial_stats.ca_mois) }} â‚¬</div>
    </div>
</div>

<h3 class="mb-3">Mon pipeline</h3>

<div class="kpi-grid">

<div class="card">
    <div class="card-header fw-bold">ðŸŸ¡ En cours ({{ pipeline_en_cours|length }})</div>
    <div class="card-body">
        {% for c in pipeline_en_cours %}
        <a href="{{ url_for('client_detail', client_id=c.id) }}" class="pipeline-card d-block mb-2 text-dark text-decoration-none">
            {{ c.name }}
        </a>
        {% else %}
        <span class="text-muted">Aucun dossier</span>
        {% endfor %}
    </div>
</div>

<div class="card">
    <div class="card-header fw-bold">ðŸŸ¢ GagnÃ©s ({{ pipeline_gagnes|length }})</div>
    <div class="card-body">
        {% for c in pipeline_gagnes %}
        <a href="{{ url_for('client_detail', client_id=c.id) }}" class="pipeline-card d-block mb-2 text-dark text-decoration-none">
            {{ c.name }}
        </a>
        {% else %}
        <span class="text-muted">Aucun dossier</span>
        {% endfor %}
    </div>
</div>

<div class="card">
    <div class="card-header fw-bold">ðŸ”´ Perdus ({{ pipeline_perdus|length }})</div>
    <div class="card-body">
        {% for c in pipeline_perdus %}
        <a href="{{ url_for('client_detail', client_id=c.id) }}" class="pipeline-card d-block mb-2 text-dark text-decoration-none">
            {{ c.name }}
        </a>
        {% else %}
        <span class="text-muted">Aucun dossier</span>
        {% endfor %}
    </div>
</div>

</div>

{% endif %}
{% endblock %}

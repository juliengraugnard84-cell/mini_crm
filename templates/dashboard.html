{% extends "base.html" %}
{% block title %}Tableau de bord{% endblock %}

{% block content %}

{% if current_user and current_user.role == 'commercial' %}

<!-- ================= DASHBOARD COMMERCIAL ================= -->
<div class="page-header" style="margin-bottom:24px;">
    <h1>Mon tableau de bord</h1>
    <p class="text-muted">Suivi de mon activitÃ© commerciale</p>
</div>

<!-- ================= KPI COMMERCIAL ================= -->
<div class="kpi-grid"
     style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px;margin-bottom:32px;">
    <div class="kpi-tile">
        <div class="kpi-label">Mes dossiers</div>
        <div class="kpi-value">{{ commercial_stats.nb_clients }}</div>
    </div>

    <div class="kpi-tile">
        <div class="kpi-label">Mon CA total</div>
        <div class="kpi-value">{{ "%.2f"|format(commercial_stats.ca_total) }} â‚¬</div>
    </div>

    <div class="kpi-tile">
        <div class="kpi-label">Mon CA du mois</div>
        <div class="kpi-value">{{ "%.2f"|format(commercial_stats.ca_mois) }} â‚¬</div>
    </div>

    <div class="kpi-tile">
        <div class="kpi-label">Cotations en attente</div>
        <div class="kpi-value">{{ commercial_stats.cotations_attente }}</div>
    </div>
</div>

<!-- ================= PIPELINE COMMERCIAL ================= -->
<h3 class="mb-3">Mon pipeline</h3>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-bottom:32px;">

    <!-- EN COURS -->
    <div class="card">
        <div class="card-header fw-bold">
            ðŸŸ¡ En cours ({{ pipeline_en_cours|length }})
        </div>
        <div class="card-body d-flex flex-column gap-2">
            {% for c in pipeline_en_cours %}
            <div class="border rounded p-2">
                <strong>{{ c.name }}</strong>
                <div class="mt-2">
                    <a href="{{ url_for('client_detail', client_id=c.id) }}"
                       class="btn btn-ouvrir btn-sm w-100">
                        Ouvrir
                    </a>
                </div>
            </div>
            {% else %}
            <p class="text-muted mb-0">Aucun dossier.</p>
            {% endfor %}
        </div>
    </div>

    <!-- GAGNÃ‰S -->
    <div class="card border-success">
        <div class="card-header fw-bold text-success">
            ðŸŸ¢ GagnÃ©s ({{ pipeline_gagnes|length }})
        </div>
        <div class="card-body d-flex flex-column gap-2">
            {% for c in pipeline_gagnes %}
            <div class="border border-success rounded p-2">
                <strong>{{ c.name }}</strong>
                <div class="mt-2">
                    <a href="{{ url_for('client_detail', client_id=c.id) }}"
                       class="btn btn-ouvrir btn-sm w-100">
                        Ouvrir
                    </a>
                </div>
            </div>
            {% else %}
            <p class="text-muted mb-0">Aucun dossier gagnÃ©.</p>
            {% endfor %}
        </div>
    </div>

    <!-- PERDUS -->
    <div class="card border-danger">
        <div class="card-header fw-bold text-danger">
            ðŸ”´ Perdus ({{ pipeline_perdus|length }})
        </div>
        <div class="card-body d-flex flex-column gap-2">
            {% for c in pipeline_perdus %}
            <div class="border border-danger rounded p-2">
                <strong>{{ c.name }}</strong>
                <div class="mt-2">
                    <a href="{{ url_for('client_detail', client_id=c.id) }}"
                       class="btn btn-ouvrir btn-sm w-100">
                        Ouvrir
                    </a>
                </div>
            </div>
            {% else %}
            <p class="text-muted mb-0">Aucun dossier perdu.</p>
            {% endfor %}
        </div>
    </div>

</div>

<!-- ================= DOSSIERS RÃ‰CENTS ================= -->
<div class="card">
    <h5>Mes dossiers rÃ©cents</h5>

    {% if commercial_clients %}
    <table class="table">
        <thead>
            <tr>
                <th>Dossier</th>
                <th>Statut</th>
                <th>Date</th>
                <th style="text-align:right;">Action</th>
            </tr>
        </thead>
        <tbody>
            {% for c in commercial_clients %}
            <tr>
                <td><strong>{{ c.name }}</strong></td>
                <td>{{ c.status or "â€”" }}</td>
                <td>{{ format_date(c.created_at) }}</td>
                <td style="text-align:right;">
                    <a href="{{ url_for('client_detail', client_id=c.id) }}"
                       class="btn btn-ouvrir btn-sm">
                        Ouvrir
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p class="text-muted">Aucun dossier.</p>
    {% endif %}
</div>

<!-- ================= MES COTATIONS ================= -->
<div class="card">
    <h5>Mes derniÃ¨res cotations</h5>

    {% if commercial_cotations %}
    <table class="table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Ã‰nergie</th>
                <th>Statut</th>
            </tr>
        </thead>
        <tbody>
            {% for c in commercial_cotations %}
            <tr>
                <td>{{ format_date(c.date_creation) }}</td>
                <td>{{ c.energie_type or "â€”" }}</td>
                <td>{{ c.status or "â€”" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p class="text-muted">Aucune cotation rÃ©cente.</p>
    {% endif %}
</div>

{% else %}

<!-- ================= DASHBOARD ADMIN ================= -->

<div class="page-header" style="margin-bottom:24px;">
    <h1>Tableau de bord</h1>
    <p class="text-muted">Vue dâ€™ensemble de lâ€™activitÃ©</p>
</div>

<!-- ================= KPI ADMIN ================= -->
<div class="kpi-grid"
     style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px;margin-bottom:32px;">
    <div class="kpi-tile">
        <div class="kpi-label">Dossiers clients</div>
        <div class="kpi-value">{{ total_clients }}</div>
    </div>

    <div class="kpi-tile">
        <div class="kpi-label">Chiffre dâ€™affaires total</div>
        <div class="kpi-value">{{ "%.2f"|format(total_ca) }} â‚¬</div>
    </div>

    <div class="kpi-tile">
        <div class="kpi-label">Documents stockÃ©s</div>
        <div class="kpi-value">{{ total_docs }}</div>
    </div>

    <div class="kpi-tile" style="border-left-color:var(--danger);">
        <div class="kpi-label">Nouvelles cotations</div>
        <div class="kpi-value">{{ unread_cotations }}</div>
    </div>
</div>

<!-- ================= PIPELINE ADMIN ================= -->
<h3 class="mb-3">Pipeline global des dossiers</h3>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-bottom:32px;">

    <div class="card">
        <div class="card-header fw-bold">
            ðŸŸ¡ En cours ({{ pipeline_en_cours|length }})
        </div>
        <div class="card-body d-flex flex-column gap-2">
            {% for c in pipeline_en_cours %}
            <div class="border rounded p-2">
                <strong>{{ c.name }}</strong><br>
                <small class="text-muted">{{ c.commercial or "â€”" }}</small>
                <a href="{{ url_for('client_detail', client_id=c.id) }}"
                   class="btn btn-ouvrir btn-sm mt-2 w-100">
                    Ouvrir
                </a>
            </div>
            {% else %}
            <p class="text-muted mb-0">Aucun dossier.</p>
            {% endfor %}
        </div>
    </div>

    <div class="card border-success">
        <div class="card-header fw-bold text-success">
            ðŸŸ¢ GagnÃ©s ({{ pipeline_gagnes|length }})
        </div>
        <div class="card-body d-flex flex-column gap-2">
            {% for c in pipeline_gagnes %}
            <div class="border border-success rounded p-2">
                <strong>{{ c.name }}</strong><br>
                <small class="text-muted">{{ c.commercial or "â€”" }}</small>
                <a href="{{ url_for('client_detail', client_id=c.id) }}"
                   class="btn btn-ouvrir btn-sm mt-2 w-100">
                    Ouvrir
                </a>
            </div>
            {% else %}
            <p class="text-muted mb-0">Aucun dossier gagnÃ©.</p>
            {% endfor %}
        </div>
    </div>

    <div class="card border-danger">
        <div class="card-header fw-bold text-danger">
            ðŸ”´ Perdus ({{ pipeline_perdus|length }})
        </div>
        <div class="card-body d-flex flex-column gap-2">
            {% for c in pipeline_perdus %}
            <div class="border border-danger rounded p-2">
                <strong>{{ c.name }}</strong><br>
                <small class="text-muted">{{ c.commercial or "â€”" }}</small>
                <a href="{{ url_for('client_detail', client_id=c.id) }}"
                   class="btn btn-ouvrir btn-sm mt-2 w-100">
                    Ouvrir
                </a>
            </div>
            {% else %}
            <p class="text-muted mb-0">Aucun dossier perdu.</p>
            {% endfor %}
        </div>
    </div>

</div>

<!-- ================= BLOCS ADMIN EXISTANTS ================= -->
<div class="card">
    <h5>Derniers dossiers crÃ©Ã©s</h5>
    {% if last_clients %}
    <table class="table">
        <thead>
            <tr>
                <th>Dossier</th>
                <th>Email</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
            {% for c in last_clients %}
            <tr>
                <td><strong>{{ c.name }}</strong></td>
                <td>{{ c.email or "â€”" }}</td>
                <td>{{ format_date(c.created_at) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p class="text-muted">Aucun dossier rÃ©cent.</p>
    {% endif %}
</div>

{% endif %}

{% endblock %}

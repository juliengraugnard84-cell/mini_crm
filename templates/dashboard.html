{% extends "base.html" %}
{% block title %}Tableau de bord{% endblock %}

{% block content %}

<!-- ================= HEADER ================= -->
<div class="page-header">
    <h1>Tableau de bord</h1>
</div>

<!-- ================= KPI ================= -->
<div class="kpi-grid">

    <div class="kpi-card">
        <span class="kpi-label">Dossiers clients</span>
        <strong class="kpi-value">{{ total_clients }}</strong>
    </div>

    <div class="kpi-card">
        <span class="kpi-label">Chiffre d’affaires total</span>
        <strong class="kpi-value">{{ total_ca }} €</strong>
    </div>

    <div class="kpi-card">
        <span class="kpi-label">Documents stockés</span>
        <strong class="kpi-value">{{ total_docs }}</strong>
    </div>

    {% if current_user and current_user.role == 'admin' %}
    <div class="kpi-card highlight">
        <span class="kpi-label">Nouvelles cotations</span>
        <strong class="kpi-value">{{ unread_cotations }}</strong>
    </div>
    {% endif %}

</div>

<!-- ================= DERNIERS DOSSIERS ================= -->
<div class="card">
    <h3 class="section-title">Derniers dossiers créés</h3>

    {% if last_clients %}
    <table class="table">
        <thead>
            <tr>
                <th>Dossier</th>
                <th>Email</th>
                <th>Date de création</th>
            </tr>
        </thead>
        <tbody>
            {% for c in last_clients %}
            <tr>
                <td><strong>{{ c.name }}</strong></td>
                <td>{{ c.email or "—" }}</td>
                <td>{{ format_date(c.created_at) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p class="text-muted">Aucun dossier récent.</p>
    {% endif %}
</div>

<!-- ================= DERNIER CA ================= -->
<div class="card">
    <h3 class="section-title ca">Dernier chiffre d’affaires enregistré</h3>

    {% if last_rev %}
        <div class="info-grid">
            <div class="info-item">
                <span>Date</span>
                <strong>{{ format_date(last_rev.date) }}</strong>
            </div>
            <div class="info-item">
                <span>Montant</span>
                <strong>{{ last_rev.montant }} €</strong>
            </div>
            <div class="info-item">
                <span>Commercial</span>
                <strong>{{ last_rev.commercial or "—" }}</strong>
            </div>
        </div>
    {% else %}
        <p class="text-muted">Aucun chiffre d’affaires enregistré.</p>
    {% endif %}
</div>

<!-- ================= NOUVELLES COTATIONS (ADMIN) ================= -->
{% if current_user and current_user.role == 'admin' %}
<div class="card">
    <h3 class="section-title cotation">
        Dernières demandes de cotation
    </h3>

    {% if cotations_admin %}
    <table class="table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Dossier</th>
                <th>Énergie</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for c in cotations_admin %}
            <tr class="{% if not c.is_read %}unread{% endif %}">
                <td>{{ format_date(c.date_creation) }}</td>
                <td><strong>{{ c.client_name }}</strong></td>
                <td>{{ c.energie_type or "—" }}</td>
                <td style="text-align:right;">
                    <a href="{{ url_for('admin_open_cotation', cotation_id=c.id) }}"
                       class="btn btn-secondary btn-sm">
                        Ouvrir
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p class="text-muted">Aucune nouvelle demande.</p>
    {% endif %}
</div>
{% endif %}

{% endblock %}

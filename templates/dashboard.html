{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}

<h1 class="page-title">Tableau de bord</h1>

<!-- KPI -->
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:24px;">

    <div class="kpi-tile">
        <div class="kpi-label">Clients</div>
        <div class="kpi-value">{{ total_clients }}</div>
    </div>

    <div class="kpi-tile">
        <div class="kpi-label">Chiffre d’affaires</div>
        <div class="kpi-value">{{ total_ca }} €</div>
    </div>

    <div class="kpi-tile">
        <div class="kpi-label">Documents</div>
        <div class="kpi-value">{{ total_docs }}</div>
    </div>

</div>

<!-- CONTENU -->
<div style="display:grid;grid-template-columns:2fr 1fr;gap:16px;">

    <!-- Derniers clients -->
    <div class="card">
        <h5>Derniers clients</h5>

        {% if last_clients %}
        <div class="list-group">
            {% for c in last_clients %}
                <div class="list-group-item">
                    <strong>{{ c.name }}</strong><br>
                    <small class="text-muted">{{ c.email or "—" }}</small>
                </div>
            {% endfor %}
        </div>
        {% else %}
            <p class="text-muted">Aucun client enregistré.</p>
        {% endif %}
    </div>

    <!-- Dernier revenu -->
    <div class="card">
        <h5>Dernier revenu</h5>

        {% if last_rev %}
            <div style="font-size:1.6rem;font-weight:700;">
                {{ last_rev.montant }} €
            </div>
            <small class="text-muted">
                {{ last_rev.date }} — {{ last_rev.commercial }}
            </small>
        {% else %}
            <p class="text-muted">Aucun revenu enregistré.</p>
        {% endif %}
    </div>

</div>

<!-- COTATIONS ADMIN -->
{% if current_user and current_user.role == 'admin' %}
<div class="card">
    <h5>Cotations non lues ({{ unread_cotations }})</h5>

    {% if cotations_admin %}
    <div class="list-group">
        {% for c in cotations_admin %}
            <!-- IMPORTANT: passer par open_cotation pour marquer "lu" -->
            <a href="{{ url_for('open_cotation', cotation_id=c.id) }}"
               class="list-group-item">
                <strong>{{ c.client_name }}</strong><br>
                <small class="text-muted">
                    {{ c.energie_type or "—" }} — échéance {{ c.date_echeance or "—" }}
                </small>
            </a>
        {% endfor %}
    </div>
    {% else %}
        <p class="text-muted">Aucune cotation non lue.</p>
    {% endif %}
</div>
{% endif %}

{% endblock %}

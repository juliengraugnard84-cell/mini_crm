{% extends "base.html" %}
{% block title %}Tableau de bord{% endblock %}

{% block content %}

{# ============================================================
   DASHBOARD COMMERCIAL
   ============================================================ #}
{% if current_user and current_user.role == 'commercial' %}

<div class="page-header mb-4">
    <h1>Mon tableau de bord</h1>
    <p class="text-muted">Suivi de mon activitÃ© commerciale</p>
</div>

<!-- ================= KPI COMMERCIAL ================= -->
<div class="kpi-grid"
     style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px;margin-bottom:32px;">

    <div class="kpi-tile">
        <div class="kpi-label">Mes dossiers</div>
        <div class="kpi-value">
            {{ commercial_stats.nb_clients if commercial_stats is defined else 0 }}
        </div>
    </div>

    <div class="kpi-tile">
        <div class="kpi-label">Mon CA total</div>
        <div class="kpi-value">
            {{ "%.2f"|format(commercial_stats.ca_total) if commercial_stats is defined else "0.00" }} â‚¬
        </div>
    </div>

    <div class="kpi-tile">
        <div class="kpi-label">Mon CA du mois</div>
        <div class="kpi-value">
            {{ "%.2f"|format(commercial_stats.ca_mois) if commercial_stats is defined else "0.00" }} â‚¬
        </div>
    </div>

    <div class="kpi-tile">
        <div class="kpi-label">Cotations en attente</div>
        <div class="kpi-value">
            {{ commercial_stats.cotations_attente if commercial_stats is defined else 0 }}
        </div>
    </div>

</div>

<!-- ================= PIPELINE COMMERCIAL ================= -->
<h3 class="mb-3">Mon pipeline</h3>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-bottom:32px;">

{% for label, color, items in [
    ('ðŸŸ¡ En cours', '', pipeline_en_cours if pipeline_en_cours is defined else []),
    ('ðŸŸ¢ GagnÃ©s', 'success', pipeline_gagnes if pipeline_gagnes is defined else []),
    ('ðŸ”´ Perdus', 'danger', pipeline_perdus if pipeline_perdus is defined else [])
] %}

<div class="card {% if color %}border-{{ color }}{% endif %}">
    <div class="card-header fw-bold {% if color %}text-{{ color }}{% endif %}">
        {{ label }} ({{ items|length }})
    </div>

    <div class="card-body d-flex flex-column gap-2">
        {% if items %}
            {% for c in items %}
            <a href="{{ url_for('client_detail', client_id=c.id) }}"
               class="pipeline-card text-decoration-none">
                <strong>{{ c.name }}</strong>
                <small class="text-muted d-block">
                    {{ c.commercial or "â€”" }}
                </small>
            </a>
            {% endfor %}
        {% else %}
            <p class="text-muted mb-0">Aucun dossier.</p>
        {% endif %}
    </div>
</div>

{% endfor %}
</div>

{# ============================================================
   DASHBOARD ADMIN
   ============================================================ #}
{% else %}

<div class="page-header mb-4">
    <h1>Tableau de bord</h1>
    <p class="text-muted">Vue dâ€™ensemble de lâ€™activitÃ©</p>
</div>

<!-- ================= KPI ADMIN ================= -->
<div class="kpi-grid"
     style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px;margin-bottom:32px;">

    <div class="kpi-tile">
        <div class="kpi-label">Dossiers clients</div>
        <div class="kpi-value">{{ total_clients if total_clients is defined else 0 }}</div>
    </div>

    <div class="kpi-tile">
        <div class="kpi-label">Chiffre dâ€™affaires total</div>
        <div class="kpi-value">
            {{ "%.2f"|format(total_ca) if total_ca is defined else "0.00" }} â‚¬
        </div>
    </div>

    <div class="kpi-tile">
        <div class="kpi-label">Documents stockÃ©s</div>
        <div class="kpi-value">{{ total_docs if total_docs is defined else 0 }}</div>
    </div>

    <div class="kpi-tile" style="border-left-color:var(--danger);">
        <div class="kpi-label">Nouvelles cotations</div>
        <div class="kpi-value">{{ unread_cotations if unread_cotations is defined else 0 }}</div>
    </div>

</div>

<!-- ================= PIPELINE ADMIN ================= -->
<h3 class="mb-3">Pipeline global des dossiers</h3>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-bottom:32px;">

{% for label, color, items in [
    ('ðŸŸ¡ En cours', 'secondary', pipeline_en_cours if pipeline_en_cours is defined else []),
    ('ðŸŸ¢ GagnÃ©s', 'success', pipeline_gagnes if pipeline_gagnes is defined else []),
    ('ðŸ”´ Perdus', 'danger', pipeline_perdus if pipeline_perdus is defined else [])
] %}

<div class="card {% if color != 'secondary' %}border-{{ color }}{% endif %}">
    <div class="card-header fw-bold {% if color != 'secondary' %}text-{{ color }}{% endif %}">
        {{ label }} ({{ items|length }})
    </div>

    <div class="card-body d-flex flex-column gap-2">
        {% if items %}
            {% for c in items %}
            <div class="pipeline-card">

                <a href="{{ url_for('client_detail', client_id=c.id) }}"
                   class="text-decoration-none">
                    <strong>{{ c.name }}</strong>
                </a>
                <small class="text-muted d-block">
                    {{ c.commercial or "â€”" }}
                </small>

                <form method="post"
                      action="{{ url_for('update_client_status', client_id=c.id) }}"
                      class="mt-2"
                      onclick="event.stopPropagation();">

                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

                    <select name="status"
                            class="form-select form-select-sm"
                            onchange="this.form.submit()">
                        <option value="en_cours" {% if c.status == 'en_cours' %}selected{% endif %}>ðŸŸ¡ En cours</option>
                        <option value="gagne" {% if c.status == 'gagne' %}selected{% endif %}>ðŸŸ¢ GagnÃ©</option>
                        <option value="perdu" {% if c.status == 'perdu' %}selected{% endif %}>ðŸ”´ Perdu</option>
                    </select>
                </form>

            </div>
            {% endfor %}
        {% else %}
            <p class="text-muted mb-0">Aucun dossier.</p>
        {% endif %}
    </div>
</div>

{% endfor %}
</div>

<!-- ================= DERNIERS DOSSIERS ================= -->
<div class="card">
    <h5>Derniers dossiers crÃ©Ã©s</h5>

    {% if last_clients is defined and last_clients %}
    <table class="table">
        <thead>
            <tr>
                <th>Dossier</th>
                <th>Email</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
            {% for c in last_clients %}
            <tr>
                <td><strong>{{ c.name }}</strong></td>
                <td>{{ c.email or "â€”" }}</td>
                <td>{{ format_date(c.created_at) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p class="text-muted">Aucun dossier rÃ©cent.</p>
    {% endif %}
</div>

{% endif %}
{% endblock %}

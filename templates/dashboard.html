{% extends "base.html" %}
{% block title %}Tableau de bord{% endblock %}

{% block content %}

<style>
/* ================= DASHBOARD UI ================= */
.kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 36px;
}

.kpi-tile {
    background: #ffffff;
    border-radius: 14px;
    padding: 20px 22px;
    box-shadow: 0 6px 18px rgba(0,0,0,.05);
    border-left: 5px solid #e5e7eb;
}

.kpi-label {
    font-size: .85rem;
    color: #6b7280;
    margin-bottom: 6px;
}

.kpi-value {
    font-size: 2rem;
    font-weight: 700;
    color: #111827;
}

.pipeline-card {
    background: #f9fafb;
    border-radius: 10px;
    padding: 12px 14px;
    transition: all .15s ease;
}

.pipeline-card:hover {
    background: #eef2ff;
}

.page-header h1 {
    font-weight: 800;
}

.page-header p {
    margin-bottom: 0;
}
</style>

{# ============================================================
   DASHBOARD COMMERCIAL
   ============================================================ #}
{% if current_user and current_user.role == 'commercial' %}

<div class="page-header mb-4">
    <div class="text-muted small mb-1">Commercial connectÃ©</div>
    <h1>Mon tableau de bord</h1>
    <p class="text-muted">Suivi de mon activitÃ© commerciale</p>
</div>

<div class="kpi-grid">
    <div class="kpi-tile">
        <div class="kpi-label">Mes dossiers</div>
        <div class="kpi-value">{{ commercial_stats.nb_clients if commercial_stats else 0 }}</div>
    </div>

    <div class="kpi-tile">
        <div class="kpi-label">Mon chiffre dâ€™affaires total</div>
        <div class="kpi-value">
            {{ "%.2f"|format(commercial_stats.ca_total) if commercial_stats else "0.00" }} â‚¬
        </div>
    </div>

    <div class="kpi-tile">
        <div class="kpi-label">Mon chiffre dâ€™affaires du mois</div>
        <div class="kpi-value">
            {{ "%.2f"|format(commercial_stats.ca_mois) if commercial_stats else "0.00" }} â‚¬
        </div>
    </div>
</div>

<h3 class="mb-3">Mon pipeline</h3>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:18px;margin-bottom:36px;">

{% for label, items in [
    ('ðŸŸ¡ En cours', pipeline.en_cours if pipeline is defined else 0),
    ('ðŸŸ¢ GagnÃ©s', pipeline.gagnes if pipeline is defined else 0),
    ('ðŸ”´ Perdus', pipeline.perdus if pipeline is defined else 0)
] %}

<div class="card border-0 shadow-sm">
    <div class="card-header fw-bold bg-white">
        {{ label }} ({{ items }})
    </div>
    <div class="card-body">
        <p class="text-muted mb-0">Vue agrÃ©gÃ©e.</p>
    </div>
</div>

{% endfor %}
</div>

{# ============================================================
   DASHBOARD ADMIN
   ============================================================ #}
{% else %}

<div class="page-header mb-4">
    <div class="text-muted small mb-1">Admin connectÃ©</div>
    <h1>Tableau de bord</h1>
    <p class="text-muted">Vue dâ€™ensemble de lâ€™activitÃ©</p>
</div>

<div class="kpi-grid">
    <div class="kpi-tile">
        <div class="kpi-label">Dossiers clients</div>
        <div class="kpi-value">{{ total_clients or 0 }}</div>
    </div>

    <div class="kpi-tile">
        <div class="kpi-label">Chiffre dâ€™affaires total</div>
        <div class="kpi-value">{{ "%.2f"|format(total_ca) }} â‚¬</div>
    </div>

    <div class="kpi-tile">
        <div class="kpi-label">Documents stockÃ©s</div>
        <div class="kpi-value">{{ total_docs or 0 }}</div>
    </div>

    <div class="kpi-tile" style="border-left-color:#ef4444;">
        <div class="kpi-label">Nouvelles cotations</div>
        <div class="kpi-value">{{ unread_cotations or 0 }}</div>
    </div>
</div>

<h3 class="mb-3">Pipeline global des dossiers</h3>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:18px;margin-bottom:36px;">

{% for label, count in [
    ('ðŸŸ¡ En cours', pipeline.en_cours if pipeline is defined else 0),
    ('ðŸŸ¢ GagnÃ©s', pipeline.gagnes if pipeline is defined else 0),
    ('ðŸ”´ Perdus', pipeline.perdus if pipeline is defined else 0)
] %}

<div class="card border-0 shadow-sm">
    <div class="card-header fw-bold bg-white">
        {{ label }} ({{ count }})
    </div>
    <div class="card-body">
        <p class="text-muted mb-0">Vue consolidÃ©e des dossiers.</p>
    </div>
</div>

{% endfor %}
</div>

<div class="card border-0 shadow-sm">
    <div class="card-header bg-white fw-bold">Derniers dossiers crÃ©Ã©s</div>

    {% if last_clients %}
    <div class="table-responsive">
        <table class="table mb-0">
            <thead>
                <tr>
                    <th>Dossier</th>
                    <th>Email</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                {% for c in last_clients %}
                <tr>
                    <td><strong>{{ c.name }}</strong></td>
                    <td>{{ c.email or "â€”" }}</td>
                    <td>{{ format_date(c.created_at) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
        <div class="p-3 text-muted">Aucun dossier rÃ©cent.</div>
    {% endif %}
</div>

{% endif %}
{% endblock %}

{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}

<h1 class="page-title mb-4">Tableau de bord</h1>

<!-- ================= KPI ================= -->
<div class="row g-4 mb-4">
    <div class="col-md-4">
        <div class="kpi-tile kpi--blue">
            <div class="kpi-label">Clients</div>
            <div class="kpi-value">{{ total_clients }}</div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="kpi-tile kpi--green">
            <div class="kpi-label">Chiffre d’affaires total</div>
            <div class="kpi-value">{{ total_ca | round(2) }} €</div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="kpi-tile kpi--orange">
            <div class="kpi-label">Documents</div>
            <div class="kpi-value">{{ total_docs }}</div>
        </div>
    </div>
</div>

<!-- ================= BLOCS ================= -->
<div class="row g-4">

    <!-- Derniers clients -->
    <div class="col-md-6">
        <div class="card p-3">
            <h5 class="mb-3">Derniers clients</h5>

            <ul class="list-group list-group-flush">
                {% for c in last_clients %}
                <li class="list-group-item">
                    <strong>{{ c.name }}</strong><br>
                    <small class="text-muted">{{ c.email or "—" }}</small>
                </li>
                {% else %}
                <li class="list-group-item text-muted">
                    Aucun client
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- Dernier revenu -->
    <div class="col-md-6">
        <div class="card p-3">
            <h5 class="mb-3">Dernier revenu</h5>

            {% if last_rev %}
                <p class="mb-1">
                    <strong>{{ last_rev.montant }} €</strong>
                </p>
                <p class="mb-1">
                    Date : {{ last_rev.date }}
                </p>
                <p class="mb-0 text-muted">
                    Commercial : {{ last_rev.commercial }}
                </p>
            {% else %}
                <p class="text-muted">
                    Aucun revenu enregistré
                </p>
            {% endif %}
        </div>
    </div>

</div>

<!-- ================= COTATIONS ADMIN ================= -->
{% if current_user and current_user.role == 'admin' %}

<div class="card p-3 mt-4">
    <h5 class="mb-3">
        Cotations non lues ({{ unread_cotations }})
    </h5>

    <ul class="list-group">
        {% for c in cotations_admin %}
        <li class="list-group-item p-0">

            <a href="{{ url_for('open_cotation', cotation_id=c.id) }}"
               class="d-block p-3 text-decoration-none text-dark">

                <strong>{{ c.client_name }}</strong>

                <div class="small text-muted mt-1">
                    {% if c.energie_type %}
                        {{ c.energie_type | capitalize }}
                        {% if c.date_echeance %}
                            — échéance {{ c.date_echeance }}
                        {% endif %}
                    {% else %}
                        Demande de cotation
                    {% endif %}
                </div>

            </a>

        </li>
        {% else %}
        <li class="list-group-item text-muted">
            Aucune cotation en attente
        </li>
        {% endfor %}
    </ul>
</div>

{% endif %}

{% endblock %}

{% extends "base.html" %}
{% block content %}

<h2 class="mb-4">Administration — Utilisateurs</h2>

<!-- ===================== CRÉATION UTILISATEUR ===================== -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
        Créer un utilisateur
    </div>

    <div class="card-body">
        <form method="POST" action="{{ url_for('admin_users') }}">
            <div class="row g-2">
                <div class="col-md-4">
                    <input type="text"
                           name="username"
                           class="form-control"
                           placeholder="Nom d'utilisateur"
                           required>
                </div>

                <div class="col-md-4">
                    <input type="password"
                           name="password"
                           class="form-control"
                           placeholder="Mot de passe"
                           required>
                </div>

                <div class="col-md-2">
                    <select name="role" class="form-select" required>
                        <option value="">Rôle</option>
                        <option value="commercial">Commercial</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <button class="btn btn-success w-100">
                        Créer
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>


<!-- ===================== LISTE UTILISATEURS ===================== -->
<div class="card shadow-sm">
    <div class="card-header bg-secondary text-white">
        Utilisateurs existants
    </div>

    <div class="card-body p-0">
        <table class="table table-striped table-hover mb-0 align-middle">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>Utilisateur</th>
                    <th>Rôle</th>
                    <th style="width: 420px;">Actions</th>
                </tr>
            </thead>
            <tbody>

            {% for u in users %}
                <tr>
                    <td>{{ u.id }}</td>
                    <td>{{ u.username }}</td>
                    <td>
                        <span class="badge {% if u.role == 'admin' %}bg-danger{% else %}bg-info{% endif %}">
                            {{ u.role }}
                        </span>
                    </td>

                    <td>

                        <!-- ===== RESET MOT DE PASSE ===== -->
                        <form method="POST"
                              action="{{ url_for('admin_reset_password', user_id=u.id) }}"
                              class="d-inline-flex align-items-center gap-1"
                              onsubmit="return confirm('Réinitialiser le mot de passe ?');">

                            <input type="password"
                                   name="new_password"
                                   class="form-control form-control-sm"
                                   placeholder="Nouveau mot de passe"
                                   required
                                   style="width: 170px;">

                            <button class="btn btn-sm btn-warning">
                                Réinitialiser
                            </button>
                        </form>

                        <!-- ===== SUPPRESSION ===== -->
                        {% if u.role != 'admin' %}
                        <form method="POST"
                              action="{{ url_for('admin_delete_user', user_id=u.id) }}"
                              class="d-inline"
                              onsubmit="return confirm('Supprimer cet utilisateur ?');">
                            <button class="btn btn-sm btn-outline-danger ms-1">
                                Supprimer
                            </button>
                        </form>
                        {% endif %}

                    </td>
                </tr>
            {% endfor %}

            </tbody>
        </table>
    </div>
</div>

{% endblock %}

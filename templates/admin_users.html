{% extends "base.html" %}
{% block title %}Utilisateurs{% endblock %}

{% block content %}

<!-- ================= PAGE HEADER ================= -->
<div class="page-header mb-4">
    <h1>Utilisateurs</h1>
    <p class="text-muted">Gestion des comptes et des accès</p>
</div>

<!-- ================= CRÉATION UTILISATEUR ================= -->
<div class="card">
    <h5>Créer un utilisateur</h5>

    <form method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

        <div class="row g-3">

            <div class="col-md-4">
                <label class="form-label">Nom d’utilisateur</label>
                <input type="text"
                       name="username"
                       class="form-control"
                       required>
            </div>

            <div class="col-md-4">
                <label class="form-label">Mot de passe</label>
                <input type="password"
                       name="password"
                       class="form-control"
                       required>
            </div>

            <div class="col-md-4">
                <label class="form-label">Rôle</label>
                <select name="role"
                        class="form-select"
                        required>
                    <option value="commercial">Commercial</option>
                    <option value="admin">Administrateur</option>
                </select>
            </div>

        </div>

        <div class="mt-3 text-end">
            <button class="btn btn-success">
                Créer l’utilisateur
            </button>
        </div>
    </form>
</div>

<!-- ================= LISTE UTILISATEURS ================= -->
<div class="card">
    <h5>Liste des utilisateurs</h5>

    {% if users %}
    <table class="table">
        <thead>
            <tr>
                <th>Utilisateur</th>
                <th>Rôle</th>
                <th style="width:420px;text-align:right;">Actions</th>
            </tr>
        </thead>
        <tbody>

        {% for u in users %}
            <tr>
                <td>
                    <strong>{{ u.username }}</strong>
                </td>

                <td>
                    {{ u.role }}
                </td>

                <td style="text-align:right;">

                    <!-- Modifier -->
                    <a href="{{ url_for('admin_edit_user', user_id=u.id) }}"
                       class="btn btn-secondary btn-sm">
                        Modifier
                    </a>

                    <!-- Reset password -->
                    <form method="POST"
                          action="{{ url_for('admin_reset_password', user_id=u.id) }}"
                          style="display:inline-block;margin-left:6px;">

                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

                        <input type="password"
                               name="new_password"
                               placeholder="Nouveau mot de passe"
                               class="form-control"
                               style="display:inline-block;width:160px;vertical-align:middle;">

                        <button class="btn btn-outline-secondary btn-sm">
                            Reset
                        </button>
                    </form>

                    <!-- Suppression -->
                    {% if u.id != 1 %}
                    <form method="POST"
                          action="{{ url_for('admin_delete_user', user_id=u.id) }}"
                          style="display:inline-block;margin-left:6px;"
                          onsubmit="return confirm('Supprimer cet utilisateur ?');">

                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

                        <button class="btn btn-danger btn-sm">
                            Supprimer
                        </button>
                    </form>
                    {% endif %}

                </td>
            </tr>
        {% endfor %}

        </tbody>
    </table>

    {% else %}
        <p class="text-muted">Aucun utilisateur enregistré.</p>
    {% endif %}
</div>

{% endblock %}

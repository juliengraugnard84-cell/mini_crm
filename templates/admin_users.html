{% extends "base.html" %}
{% block title %}Utilisateurs{% endblock %}

{% block content %}

<h1 class="page-title">Administration — Utilisateurs</h1>

<!-- ===================================================== -->
<!-- CRÉATION UTILISATEUR -->
<!-- ===================================================== -->
<div class="card admin-card mb-4">
    <h5>Créer un utilisateur</h5>

    <form method="POST" action="{{ url_for('admin_users') }}">
        <div>
            <label class="form-label">Nom d'utilisateur</label>
            <input type="text" name="username" class="form-control" required>
        </div>

        <div>
            <label class="form-label">Mot de passe</label>
            <input type="password" name="password" class="form-control" required>
        </div>

        <div>
            <label class="form-label">Rôle</label>
            <select name="role" class="form-select" required>
                <option value="">— Sélectionner —</option>
                <option value="admin">Admin</option>
                <option value="commercial">Commercial</option>
            </select>
        </div>

        <div></div>

        <button class="btn btn-primary">
            Créer l'utilisateur
        </button>
    </form>
</div>

<!-- ===================================================== -->
<!-- LISTE UTILISATEURS -->
<!-- ===================================================== -->
<div class="card admin-card">
    <h5>Utilisateurs existants</h5>

    <table class="admin-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Utilisateur</th>
                <th>Rôle</th>
                <th style="width: 45%">Actions</th>
            </tr>
        </thead>

        <tbody>
        {% for u in users %}
            <tr>
                <td>{{ u.id }}</td>

                <td>
                    <strong>{{ u.username }}</strong>
                </td>

                <td>
                    <span class="role-badge">{{ u.role }}</span>
                </td>

                <td>
                    <div class="admin-actions">

                        <!-- RESET PASSWORD -->
                        <form method="POST"
                              action="{{ url_for('admin_reset_password', user_id=u.id) }}">
                            <input type="password"
                                   name="new_password"
                                   class="form-control"
                                   placeholder="Nouveau mot de passe"
                                   required>
                        </form>

                        <form method="POST"
                              action="{{ url_for('admin_reset_password', user_id=u.id) }}">
                            <input type="hidden" name="new_password" value="">
                            <button class="btn btn-outline-secondary">
                                Réinitialiser
                            </button>
                        </form>

                        <!-- SUPPRESSION (SAUF ADMIN PRINCIPAL) -->
                        {% if u.id != 1 %}
                        <form method="POST"
                              action="{{ url_for('admin_delete_user', user_id=u.id) }}"
                              onsubmit="return confirm('Supprimer cet utilisateur ?');">
                            <button class="btn btn-danger">
                                Supprimer
                            </button>
                        </form>
                        {% endif %}

                    </div>
                </td>
            </tr>
        {% else %}
            <tr>
                <td colspan="4" class="text-muted">
                    Aucun utilisateur enregistré.
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}
